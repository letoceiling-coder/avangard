# Решение проблемы ObjectId для blocks API

## Проблема

API блоков требует MongoDB ObjectId для параметра `city`, но в базе данных городов может не быть `external_id` (MongoDB ObjectId).

## Решение

Код изменен для использования `external_id` если он есть. Если `external_id` отсутствует, будет использоваться `guid`, что приведет к ошибке 400.

## Как получить ObjectId для городов

### Способ 1: Из ответа API blocks (рекомендуется)

При парсинге blocks, в ответе API обычно есть информация о городе каждого блока. Можно извлечь `city._id` из первого успешного ответа и обновить `external_id` города.

**Пример структуры ответа:**
```json
{
  "data": [
    {
      "_id": "...",
      "city": {
        "_id": "507f1f77bcf86cd799439011",  // Это ObjectId города
        "guid": "msk",
        "name": "Москва"
      },
      ...
    }
  ]
}
```

### Способ 2: Получить из другого API endpoint

Если есть endpoint для получения списка городов (например, `/cities`), можно использовать его для получения `_id` для каждого города.

### Способ 3: Обновить вручную

Можно вручную обновить `external_id` в таблице `cities` для каждого города:

```sql
UPDATE cities SET external_id = '507f1f77bcf86cd799439011' WHERE guid = 'msk';
```

Где `507f1f77bcf86cd799439011` - это MongoDB ObjectId города, полученный из API TrendAgent.

## Рекомендация

Лучше всего автоматизировать получение `external_id` из первого успешного ответа API при парсинге blocks. Это можно сделать в методе синхронизации blocks, обновляя `external_id` города, если он еще не заполнен.

## Текущий статус

- ✅ Код обновлен для использования `external_id`
- ⚠️ Требуется заполнение `external_id` для городов
- ⚠️ При отсутствии `external_id` будет использоваться `guid`, что приведет к ошибке 400

