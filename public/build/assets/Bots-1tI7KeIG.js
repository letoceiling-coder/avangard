import{_ as I,c as d,a as e,b,t as c,F as S,q,w as N,d as f,v as w,N as z,r as m,m as J,k as O,i as A,o as u,p as C}from"./admin-Be576Grm.js";import{c as j,b as M,a as F,d as G}from"./api-BACpyIk9.js";import{S as x}from"./sweetalert2.esm.all-C0u8rGqG.js";const L={name:"Bots",setup(){A();const v=m(!1),o=m(!1),h=m(null),t=m([]),_=m(!1),k=m(!1),s=m(null),g=m(null),y=m(null),a=m({id:null,name:"",token:"",welcome_message:"",is_active:!0,settings:{},webhook_allowed_updates:"message, callback_query",webhook_max_connections:40,webhook_secret_token:""}),W=J({get:()=>{try{return JSON.stringify(a.value.settings||{},null,2)}catch{return"{}"}},set:n=>{try{a.value.settings=JSON.parse(n||"{}")}catch{}}}),p=async()=>{v.value=!0,h.value=null;try{const n=await j("/bots");if(!n.ok){const r=await n.json().catch(()=>({}));throw new Error(r.message||"Ошибка загрузки ботов")}const l=await n.json();t.value=l.data||[]}catch(n){h.value=n.message||"Ошибка загрузки ботов"}finally{v.value=!1}},T=n=>{const l=n.settings||{},r=l.webhook||{};a.value={id:n.id,name:n.name||"",token:n.token||"",welcome_message:n.welcome_message||"",is_active:n.is_active!==void 0?n.is_active:!0,settings:l,webhook_allowed_updates:Array.isArray(r.allowed_updates)?r.allowed_updates.join(", "):r.allowed_updates||"message, callback_query",webhook_max_connections:r.max_connections||40,webhook_secret_token:r.secret_token||""},k.value=!0},U=async n=>{if((await x.fire({title:"Удалить бота?",html:`Вы уверены, что хотите удалить бота <strong>"${n.name}"</strong>?`,icon:"warning",showCancelButton:!0,confirmButtonText:"Да, удалить",cancelButtonText:"Отмена",confirmButtonColor:"#dc2626",cancelButtonColor:"#6b7280"})).isConfirmed)try{const r=await G(`/bots/${n.id}`);if(!r.ok){const i=await r.json().catch(()=>({}));throw new Error(i.message||"Ошибка удаления бота")}await x.fire({title:"Бот удален",icon:"success",timer:2e3,showConfirmButton:!1,toast:!0,position:"top-end"}),await p()}catch(r){x.fire({title:"Ошибка",text:r.message||"Ошибка удаления бота",icon:"error",confirmButtonText:"ОК"})}},V=async()=>{o.value=!0,h.value=null;try{const n={name:a.value.name.trim(),token:a.value.token.trim(),welcome_message:a.value.welcome_message?.trim()||null,is_active:a.value.is_active},l=a.value.webhook_allowed_updates.split(",").map(i=>i.trim()).filter(i=>i);if(n.webhook={allowed_updates:l,max_connections:a.value.webhook_max_connections||40},a.value.webhook_secret_token?.trim()&&(n.webhook.secret_token=a.value.webhook_secret_token.trim()),k.value){const i={...a.value.settings,webhook:n.webhook};n.settings=i}let r;if(k.value?r=await F(`/bots/${a.value.id}`,n):r=await M("/bots",n),!r.ok){const i=await r.json().catch(()=>({}));throw new Error(i.message||"Ошибка сохранения бота")}await x.fire({title:k.value?"Бот обновлен":"Бот создан",icon:"success",timer:2e3,showConfirmButton:!1,toast:!0,position:"top-end"}),B(),await p()}catch(n){h.value=n.message||"Ошибка сохранения бота",x.fire({title:"Ошибка",text:n.message||"Ошибка сохранения бота",icon:"error",confirmButtonText:"ОК"})}finally{o.value=!1}},E=async n=>{s.value=n.id;try{const l=await j(`/bots/${n.id}/check-webhook`);if(!l.ok){const i=await l.json().catch(()=>({}));throw new Error(i.message||"Ошибка проверки webhook")}const r=await l.json();y.value=r.data?.data||r.data||{}}catch(l){x.fire({title:"Ошибка",text:l.message||"Ошибка проверки webhook",icon:"error",confirmButtonText:"ОК"})}finally{s.value=null}},D=async n=>{g.value=n.id;try{const l=await M(`/bots/${n.id}/register-webhook`);if(!l.ok){const i=await l.json().catch(()=>({}));throw new Error(i.message||"Ошибка регистрации webhook")}const r=await l.json();await x.fire({title:r.success?"Webhook установлен":"Ошибка",text:r.message||(r.success?"Webhook успешно установлен":"Не удалось установить webhook"),icon:r.success?"success":"error",confirmButtonText:"ОК"}),await p()}catch(l){x.fire({title:"Ошибка",text:l.message||"Ошибка регистрации webhook",icon:"error",confirmButtonText:"ОК"})}finally{g.value=null}},B=()=>{_.value=!1,k.value=!1,a.value={id:null,name:"",token:"",welcome_message:"",is_active:!0,settings:{},webhook_allowed_updates:"message, callback_query",webhook_max_connections:40,webhook_secret_token:""}};return O(()=>{p()}),{loading:v,saving:o,error:h,bots:t,showCreateModal:_,showEditModal:k,form:a,settingsJson:W,checkingWebhook:s,registeringWebhook:g,webhookInfo:y,editBot:T,deleteBot:U,saveBot:V,checkWebhook:E,registerWebhook:D,closeModal:B}}},P={class:"bots-page space-y-6"},R={class:"flex items-center justify-between"},H={key:0,class:"flex items-center justify-center py-12"},K={key:1,class:"p-4 bg-destructive/10 border border-destructive/20 rounded-lg"},Q={class:"text-destructive"},X={key:2,class:"grid gap-4 md:grid-cols-2 lg:grid-cols-3"},Y={class:"flex items-start justify-between mb-4"},Z={class:"text-lg font-semibold text-foreground"},$={key:0,class:"text-sm text-muted-foreground mt-1"},ee={class:"space-y-2 mb-4"},oe={class:"flex items-center justify-between text-sm"},te=["title"],se={class:"flex flex-wrap gap-2"},ne=["onClick","disabled"],re=["onClick","disabled"],le=["onClick"],ae=["onClick"],ie=["onClick"],de={key:3,class:"bg-card rounded-lg border border-border p-12 text-center"},ce={key:4,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4"},ue={class:"bg-background border border-border rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto"},be={class:"sticky top-0 bg-background border-b border-border p-6"},me={class:"text-lg font-semibold"},ge={class:"flex items-center gap-2 cursor-pointer"},fe={key:0,class:"space-y-4"},xe={class:"space-y-3"},ke={class:"flex gap-2 pt-4 border-t border-border"},we=["disabled"],he={key:5,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4"},ve={class:"bg-background border border-border rounded-lg shadow-2xl w-full max-w-md"},pe={class:"p-6"},_e={class:"space-y-3"},ye={class:"text-sm text-foreground break-all"},Be={class:"text-sm text-foreground"},Ce={key:0},je={class:"text-sm text-red-500"};function Me(v,o,h,t,_,k){return u(),d("div",P,[e("div",R,[o[13]||(o[13]=e("div",null,[e("h1",{class:"text-3xl font-semibold text-foreground"},"Боты"),e("p",{class:"text-muted-foreground mt-1"},"Управление Telegram ботами")],-1)),e("button",{onClick:o[0]||(o[0]=s=>t.showCreateModal=!0),class:"h-11 px-6 bg-accent/10 backdrop-blur-xl text-accent border border-accent/40 hover:bg-accent/20 rounded-2xl shadow-lg shadow-accent/10 inline-flex items-center justify-center gap-2"},[...o[12]||(o[12]=[e("span",null,"+",-1),e("span",null,"Добавить бота",-1)])])]),t.loading?(u(),d("div",H,[...o[14]||(o[14]=[e("p",{class:"text-muted-foreground"},"Загрузка ботов...",-1)])])):b("",!0),t.error?(u(),d("div",K,[e("p",Q,c(t.error),1)])):b("",!0),!t.loading&&t.bots.length>0?(u(),d("div",X,[(u(!0),d(S,null,q(t.bots,s=>(u(),d("div",{key:s.id,class:"bg-card rounded-lg border border-border p-6 hover:shadow-md transition-shadow"},[e("div",Y,[e("div",null,[e("h3",Z,c(s.name),1),s.username?(u(),d("p",$,"@"+c(s.username),1)):b("",!0)]),e("span",{class:C(["px-2 py-1 text-xs rounded-md",s.is_active?"bg-green-500/10 text-green-500":"bg-gray-500/10 text-gray-500"])},c(s.is_active?"Активен":"Неактивен"),3)]),e("div",ee,[e("div",oe,[o[15]||(o[15]=e("span",{class:"text-muted-foreground"},"Webhook:",-1)),e("span",{class:C(["px-2 py-1 text-xs rounded-md",s.webhook_registered?"bg-green-500/10 text-green-500":"bg-red-500/10 text-red-500"])},c(s.webhook_registered?"Установлен":"Не установлен"),3)]),s.webhook_url?(u(),d("div",{key:0,class:"text-xs text-muted-foreground truncate",title:s.webhook_url},c(s.webhook_url),9,te)):b("",!0)]),e("div",se,[e("button",{onClick:g=>t.checkWebhook(s),disabled:t.checkingWebhook===s.id,class:"flex-1 px-3 py-1 text-xs bg-blue-500 hover:bg-blue-600 text-white rounded transition-colors disabled:opacity-50"},c(t.checkingWebhook===s.id?"Проверка...":"Проверить"),9,ne),e("button",{onClick:g=>t.registerWebhook(s),disabled:t.registeringWebhook===s.id,class:"flex-1 px-3 py-1 text-xs bg-green-500 hover:bg-green-600 text-white rounded transition-colors disabled:opacity-50"},c(t.registeringWebhook===s.id?"Регистрация...":"Установить"),9,re),e("button",{onClick:g=>v.$router.push({name:"admin.bots.management",params:{botId:s.id}}),class:"px-3 py-1 text-xs bg-blue-500 hover:bg-blue-600 text-white rounded transition-colors"}," Управление ",8,le),e("button",{onClick:g=>t.editBot(s),class:"px-3 py-1 text-xs bg-yellow-500 hover:bg-yellow-600 text-white rounded transition-colors"}," Редактировать ",8,ae),e("button",{onClick:g=>t.deleteBot(s),class:"px-3 py-1 text-xs bg-red-500 hover:bg-red-600 text-white rounded transition-colors"}," Удалить ",8,ie)])]))),128))])):b("",!0),!t.loading&&t.bots.length===0?(u(),d("div",de,[...o[16]||(o[16]=[e("p",{class:"text-muted-foreground"},"Боты не найдены. Добавьте первого бота.",-1)])])):b("",!0),t.showCreateModal||t.showEditModal?(u(),d("div",ce,[e("div",ue,[e("div",be,[e("h3",me,c(t.showEditModal?"Редактировать бота":"Добавить бота"),1)]),e("form",{onSubmit:o[10]||(o[10]=N((...s)=>t.saveBot&&t.saveBot(...s),["prevent"])),class:"p-6 space-y-4"},[e("div",null,[o[17]||(o[17]=e("label",{class:"text-sm font-medium mb-1 block"},"Название бота *",-1)),f(e("input",{"onUpdate:modelValue":o[1]||(o[1]=s=>t.form.name=s),type:"text",required:"",placeholder:"Мой бот",class:"w-full h-10 px-3 border border-border rounded bg-background focus:outline-none focus:ring-2 focus:ring-ring"},null,512),[[w,t.form.name]])]),e("div",null,[o[18]||(o[18]=e("label",{class:"text-sm font-medium mb-1 block"},"Токен бота *",-1)),f(e("input",{"onUpdate:modelValue":o[2]||(o[2]=s=>t.form.token=s),type:"text",required:"",placeholder:"1234567890:ABCdefGHIjklMNOpqrsTUVwxyz",class:"w-full h-10 px-3 border border-border rounded bg-background focus:outline-none focus:ring-2 focus:ring-ring font-mono text-sm"},null,512),[[w,t.form.token]]),o[19]||(o[19]=e("p",{class:"text-xs text-muted-foreground mt-1"},"Получить токен можно у @BotFather",-1))]),e("div",null,[o[20]||(o[20]=e("label",{class:"text-sm font-medium mb-1 block"},"Приветственное сообщение",-1)),f(e("textarea",{"onUpdate:modelValue":o[3]||(o[3]=s=>t.form.welcome_message=s),rows:"4",placeholder:"Добро пожаловать! Это приветственное сообщение...",class:"w-full px-3 py-2 border border-border rounded bg-background focus:outline-none focus:ring-2 focus:ring-ring resize-none"},null,512),[[w,t.form.welcome_message]])]),e("div",null,[o[22]||(o[22]=e("label",{class:"text-sm font-medium mb-1 block"},"Активен",-1)),e("label",ge,[f(e("input",{"onUpdate:modelValue":o[4]||(o[4]=s=>t.form.is_active=s),type:"checkbox",class:"w-4 h-4"},null,512),[[z,t.form.is_active]]),o[21]||(o[21]=e("span",{class:"text-sm"},"Бот активен",-1))])]),t.showEditModal?(u(),d("div",fe,[e("div",null,[o[26]||(o[26]=e("label",{class:"text-sm font-medium mb-2 block"},"Настройки Webhook",-1)),e("div",xe,[e("div",null,[o[23]||(o[23]=e("label",{class:"text-xs text-muted-foreground mb-1 block"},"Разрешенные обновления (через запятую)",-1)),f(e("input",{"onUpdate:modelValue":o[5]||(o[5]=s=>t.form.webhook_allowed_updates=s),type:"text",placeholder:"message, callback_query",class:"w-full h-10 px-3 border border-border rounded bg-background focus:outline-none focus:ring-2 focus:ring-ring text-sm"},null,512),[[w,t.form.webhook_allowed_updates]])]),e("div",null,[o[24]||(o[24]=e("label",{class:"text-xs text-muted-foreground mb-1 block"},"Максимальное количество соединений (1-100)",-1)),f(e("input",{"onUpdate:modelValue":o[6]||(o[6]=s=>t.form.webhook_max_connections=s),type:"number",min:"1",max:"100",placeholder:"40",class:"w-full h-10 px-3 border border-border rounded bg-background focus:outline-none focus:ring-2 focus:ring-ring text-sm"},null,512),[[w,t.form.webhook_max_connections,void 0,{number:!0}]])]),e("div",null,[o[25]||(o[25]=e("label",{class:"text-xs text-muted-foreground mb-1 block"},"Secret Token (опционально)",-1)),f(e("input",{"onUpdate:modelValue":o[7]||(o[7]=s=>t.form.webhook_secret_token=s),type:"text",placeholder:"Секретный токен",class:"w-full h-10 px-3 border border-border rounded bg-background focus:outline-none focus:ring-2 focus:ring-ring text-sm font-mono"},null,512),[[w,t.form.webhook_secret_token]])])])]),e("div",null,[o[27]||(o[27]=e("label",{class:"text-sm font-medium mb-1 block"},"Дополнительные настройки (JSON)",-1)),f(e("textarea",{"onUpdate:modelValue":o[8]||(o[8]=s=>t.settingsJson=s),rows:"6",placeholder:'{"key": "value"}',class:"w-full px-3 py-2 border border-border rounded bg-background focus:outline-none focus:ring-2 focus:ring-ring resize-none font-mono text-sm"},null,512),[[w,t.settingsJson]])])])):b("",!0),e("div",ke,[e("button",{type:"button",onClick:o[9]||(o[9]=(...s)=>t.closeModal&&t.closeModal(...s)),class:"flex-1 h-10 px-4 border border-border bg-background/50 hover:bg-accent/10 rounded-lg transition-colors"}," Отмена "),e("button",{type:"submit",disabled:t.saving,class:"flex-1 h-10 px-4 bg-accent/10 backdrop-blur-xl text-accent border border-accent/40 hover:bg-accent/20 rounded-lg transition-colors disabled:opacity-50"},c(t.saving?"Сохранение...":"Сохранить"),9,we)])],32)])])):b("",!0),t.webhookInfo?(u(),d("div",he,[e("div",ve,[e("div",pe,[o[31]||(o[31]=e("h3",{class:"text-lg font-semibold mb-4"},"Информация о webhook",-1)),e("div",_e,[e("div",null,[o[28]||(o[28]=e("span",{class:"text-sm font-medium text-muted-foreground"},"URL:",-1)),e("p",ye,c(t.webhookInfo.url||"Не установлен"),1)]),e("div",null,[o[29]||(o[29]=e("span",{class:"text-sm font-medium text-muted-foreground"},"Ожидающие обновления:",-1)),e("p",Be,c(t.webhookInfo.pending_update_count||0),1)]),t.webhookInfo.last_error_message?(u(),d("div",Ce,[o[30]||(o[30]=e("span",{class:"text-sm font-medium text-muted-foreground"},"Последняя ошибка:",-1)),e("p",je,c(t.webhookInfo.last_error_message),1)])):b("",!0)]),e("button",{onClick:o[11]||(o[11]=s=>t.webhookInfo=null),class:"w-full mt-4 h-10 px-4 bg-accent/10 backdrop-blur-xl text-accent border border-accent/40 hover:bg-accent/20 rounded-lg transition-colors"}," Закрыть ")])])])):b("",!0)])}const Ve=I(L,[["render",Me]]);export{Ve as default};
