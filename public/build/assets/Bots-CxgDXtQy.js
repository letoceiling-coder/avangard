import{_ as V,c as d,a as e,b as g,t as c,F as q,q as N,w as J,d as k,v as w,N as R,r as b,m as z,k as P,o as u,p as E}from"./admin-DXM4E0mc.js";import{c as S,b as W,a as O,d as F}from"./api-BACpyIk9.js";import{S as f}from"./sweetalert2.esm.all-C0u8rGqG.js";const G={name:"Bots",setup(){console.log("[Bots] Component setup started");const p=b(!1),o=b(!1),v=b(null),t=b([]),_=b(!1),h=b(!1),r=b(null),x=b(null),B=b(null),i=b({id:null,name:"",token:"",welcome_message:"",is_active:!0,settings:{},webhook_allowed_updates:"message, callback_query",webhook_max_connections:40,webhook_secret_token:""}),M=z({get:()=>{try{const s=i.value.settings||{};return JSON.stringify(s,null,2)}catch(s){return console.error("[Bots] Error stringifying settings:",s),"{}"}},set:s=>{try{const n=JSON.parse(s||"{}");i.value.settings=n}catch(n){console.error("[Bots] Error parsing settings JSON:",n)}}}),y=async()=>{console.log("[Bots] fetchBots called"),p.value=!0,v.value=null;try{console.log("[Bots] Making API request to /v1/bots");const s=await S("/v1/bots");if(console.log("[Bots] API response status:",s.ok,s.status),!s.ok){let l={};try{l=await s.json()}catch(m){console.error("[Bots] Error parsing error response:",m)}const a=l.message||`HTTP ${s.status}: ${s.statusText}`;throw console.error("[Bots] API error:",a),new Error(a)}const n=await s.json();console.log("[Bots] API response data:",n),n&&n.data&&Array.isArray(n.data)?(t.value=n.data,console.log("[Bots] Bots loaded:",n.data.length)):Array.isArray(n)?(t.value=n,console.log("[Bots] Bots loaded (array format):",n.length)):(t.value=[],console.warn("[Bots] Unexpected data format:",n))}catch(s){console.error("[Bots] Error in fetchBots:",s),v.value=s.message||"Ошибка загрузки ботов"}finally{p.value=!1,console.log("[Bots] fetchBots completed")}},j=()=>{console.log("[Bots] handleCreateClick"),_.value=!0},D=s=>{console.log("[Bots] handleEditBot:",s);try{const n=s.settings||{},l=n.webhook||{};i.value={id:s.id,name:s.name||"",token:s.token||"",welcome_message:s.welcome_message||"",is_active:s.is_active!==void 0?s.is_active:!0,settings:n,webhook_allowed_updates:Array.isArray(l.allowed_updates)?l.allowed_updates.join(", "):l.allowed_updates||"message, callback_query",webhook_max_connections:l.max_connections||40,webhook_secret_token:l.secret_token||""},h.value=!0,console.log("[Bots] Edit form initialized")}catch(n){console.error("[Bots] Error in handleEditBot:",n),f.fire({title:"Ошибка",text:"Не удалось загрузить данные бота",icon:"error",confirmButtonText:"ОК"})}},T=async s=>{if(console.log("[Bots] handleDeleteBot:",s),!(await f.fire({title:"Удалить бота?",html:`Вы уверены, что хотите удалить бота <strong>"${s.name}"</strong>?`,icon:"warning",showCancelButton:!0,confirmButtonText:"Да, удалить",cancelButtonText:"Отмена",confirmButtonColor:"#dc2626",cancelButtonColor:"#6b7280"})).isConfirmed){console.log("[Bots] Delete cancelled");return}try{console.log("[Bots] Deleting bot:",s.id);const l=await F(`/v1/bots/${s.id}`);if(console.log("[Bots] Delete response:",l.ok,l.status),!l.ok){let a={};try{a=await l.json()}catch(m){console.error("[Bots] Error parsing delete error response:",m)}throw new Error(a.message||"Ошибка удаления бота")}await f.fire({title:"Бот удален",icon:"success",timer:2e3,showConfirmButton:!1,toast:!0,position:"top-end"}),await y()}catch(l){console.error("[Bots] Error in handleDeleteBot:",l),f.fire({title:"Ошибка",text:l.message||"Ошибка удаления бота",icon:"error",confirmButtonText:"ОК"})}},I=async()=>{console.log("[Bots] handleSaveBot called"),o.value=!0,v.value=null;try{const s={name:i.value.name.trim(),token:i.value.token.trim(),welcome_message:i.value.welcome_message?.trim()||null,is_active:i.value.is_active},n=i.value.webhook_allowed_updates.split(",").map(a=>a.trim()).filter(a=>a);if(s.webhook={allowed_updates:n,max_connections:i.value.webhook_max_connections||40},i.value.webhook_secret_token?.trim()&&(s.webhook.secret_token=i.value.webhook_secret_token.trim()),h.value){const a={...i.value.settings,webhook:s.webhook};s.settings=a}console.log("[Bots] Saving bot data:",s);let l;if(h.value?(console.log("[Bots] Updating bot:",i.value.id),l=await O(`/v1/bots/${i.value.id}`,s)):(console.log("[Bots] Creating bot"),l=await W("/v1/bots",s)),console.log("[Bots] Save response:",l.ok,l.status),!l.ok){let a={};try{a=await l.json()}catch(m){console.error("[Bots] Error parsing save error response:",m)}throw new Error(a.message||"Ошибка сохранения бота")}await f.fire({title:h.value?"Бот обновлен":"Бот создан",icon:"success",timer:2e3,showConfirmButton:!1,toast:!0,position:"top-end"}),C(),await y()}catch(s){console.error("[Bots] Error in handleSaveBot:",s),v.value=s.message||"Ошибка сохранения бота",f.fire({title:"Ошибка",text:s.message||"Ошибка сохранения бота",icon:"error",confirmButtonText:"ОК"})}finally{o.value=!1,console.log("[Bots] handleSaveBot completed")}},U=async s=>{console.log("[Bots] handleCheckWebhook:",s),r.value=s.id;try{console.log("[Bots] Checking webhook for bot:",s.id);const n=await S(`/v1/bots/${s.id}/check-webhook`);if(console.log("[Bots] Check webhook response:",n.ok,n.status),!n.ok){let a={};try{a=await n.json()}catch(m){console.error("[Bots] Error parsing check webhook error response:",m)}throw new Error(a.message||"Ошибка проверки webhook")}const l=await n.json();console.log("[Bots] Webhook info:",l),B.value=l.data?.data||l.data||{}}catch(n){console.error("[Bots] Error in handleCheckWebhook:",n),f.fire({title:"Ошибка",text:n.message||"Ошибка проверки webhook",icon:"error",confirmButtonText:"ОК"})}finally{r.value=null}},A=async s=>{console.log("[Bots] handleRegisterWebhook:",s),x.value=s.id;try{console.log("[Bots] Registering webhook for bot:",s.id);const n=await W(`/v1/bots/${s.id}/register-webhook`);if(console.log("[Bots] Register webhook response:",n.ok,n.status),!n.ok){let a={};try{a=await n.json()}catch(m){console.error("[Bots] Error parsing register webhook error response:",m)}throw new Error(a.message||"Ошибка регистрации webhook")}const l=await n.json();console.log("[Bots] Register webhook result:",l),await f.fire({title:l.success?"Webhook установлен":"Ошибка",text:l.message||(l.success?"Webhook успешно установлен":"Не удалось установить webhook"),icon:l.success?"success":"error",confirmButtonText:"ОК"}),await y()}catch(n){console.error("[Bots] Error in handleRegisterWebhook:",n),f.fire({title:"Ошибка",text:n.message||"Ошибка регистрации webhook",icon:"error",confirmButtonText:"ОК"})}finally{x.value=null}},C=()=>{console.log("[Bots] handleCloseModal"),_.value=!1,h.value=!1,i.value={id:null,name:"",token:"",welcome_message:"",is_active:!0,settings:{},webhook_allowed_updates:"message, callback_query",webhook_max_connections:40,webhook_secret_token:""}};return P(()=>{console.log("[Bots] Component mounted, fetching bots"),y().catch(s=>{console.error("[Bots] Error in onMounted fetchBots:",s)})}),console.log("[Bots] Component setup completed"),{loading:p,saving:o,error:v,bots:t,showCreateModal:_,showEditModal:h,form:i,settingsJson:M,checkingWebhook:r,registeringWebhook:x,webhookInfo:B,handleCreateClick:j,handleEditBot:D,handleDeleteBot:T,handleSaveBot:I,handleCheckWebhook:U,handleRegisterWebhook:A,handleCloseModal:C}}},H={class:"bots-page space-y-6"},L={class:"flex items-center justify-between mb-6"},K={key:0,class:"flex items-center justify-center py-12"},Q={key:1,class:"p-4 bg-destructive/10 border border-destructive/20 rounded-lg"},X={class:"text-destructive"},Y={key:2,class:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"},Z={class:"flex items-start justify-between mb-4"},$={class:"text-lg font-semibold text-foreground"},ee={key:0,class:"text-sm text-muted-foreground"},oe={class:"space-y-2 mb-4"},te={class:"flex items-center justify-between text-sm"},se=["title"],re={class:"flex flex-wrap gap-2"},ne=["onClick","disabled"],le=["onClick","disabled"],ae=["onClick"],ie=["onClick"],de={key:3,class:"bg-card rounded-lg border border-border p-12 text-center"},ce={key:4,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4"},ue={class:"bg-background border border-border rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto"},ge={class:"sticky top-0 bg-background border-b border-border p-6"},be={class:"text-lg font-semibold"},me={class:"flex items-center gap-2 cursor-pointer"},fe={key:0,class:"space-y-4"},ke={class:"space-y-3"},he={class:"flex gap-2 pt-4 border-t border-border"},xe=["disabled"],we={key:5,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4"},ve={class:"bg-background border border-border rounded-lg shadow-2xl w-full max-w-md"},pe={class:"p-6"},_e={class:"space-y-3"},ye={class:"text-sm text-foreground break-all"},Be={class:"text-sm text-foreground"},Ce={key:0},Ee={class:"text-sm text-red-500"},Se={key:1},We={class:"text-sm text-foreground"};function Me(p,o,v,t,_,h){return u(),d("div",H,[e("div",L,[o[13]||(o[13]=e("div",null,[e("h1",{class:"text-3xl font-semibold text-foreground"},"Боты"),e("p",{class:"text-muted-foreground mt-1"},"Управление Telegram ботами")],-1)),e("button",{onClick:o[0]||(o[0]=(...r)=>t.handleCreateClick&&t.handleCreateClick(...r)),class:"h-11 px-6 bg-accent/10 backdrop-blur-xl text-accent border border-accent/40 hover:bg-accent/20 rounded-2xl shadow-lg shadow-accent/10 inline-flex items-center justify-center gap-2"},[...o[12]||(o[12]=[e("span",null,"+",-1),e("span",null,"Добавить бота",-1)])])]),t.loading?(u(),d("div",K,[...o[14]||(o[14]=[e("p",{class:"text-muted-foreground"},"Загрузка ботов...",-1)])])):g("",!0),t.error?(u(),d("div",Q,[e("p",X,c(t.error),1)])):g("",!0),!t.loading&&t.bots.length>0?(u(),d("div",Y,[(u(!0),d(q,null,N(t.bots,r=>(u(),d("div",{key:r.id,class:"bg-card rounded-lg border border-border p-6 hover:shadow-lg transition-shadow"},[e("div",Z,[e("div",null,[e("h3",$,c(r.name||"Без имени"),1),r.username?(u(),d("p",ee,"@"+c(r.username),1)):g("",!0)]),e("span",{class:E(["px-2 py-1 text-xs rounded-md",r.is_active?"bg-green-500/10 text-green-500":"bg-gray-500/10 text-gray-500"])},c(r.is_active?"Активен":"Неактивен"),3)]),e("div",oe,[e("div",te,[o[15]||(o[15]=e("span",{class:"text-muted-foreground"},"Webhook:",-1)),e("span",{class:E(["px-2 py-1 text-xs rounded-md",r.webhook_registered?"bg-green-500/10 text-green-500":"bg-red-500/10 text-red-500"])},c(r.webhook_registered?"Установлен":"Не установлен"),3)]),r.webhook_url?(u(),d("div",{key:0,class:"text-xs text-muted-foreground truncate",title:r.webhook_url},c(r.webhook_url),9,se)):g("",!0)]),e("div",re,[e("button",{onClick:x=>t.handleCheckWebhook(r),disabled:t.checkingWebhook===r.id,class:"flex-1 px-3 py-2 text-xs bg-blue-500/10 hover:bg-blue-500/20 text-blue-500 rounded-lg transition-colors disabled:opacity-50"},c(t.checkingWebhook===r.id?"Проверка...":"Проверить webhook"),9,ne),e("button",{onClick:x=>t.handleRegisterWebhook(r),disabled:t.registeringWebhook===r.id,class:"flex-1 px-3 py-2 text-xs bg-green-500/10 hover:bg-green-500/20 text-green-500 rounded-lg transition-colors disabled:opacity-50"},c(t.registeringWebhook===r.id?"Регистрация...":"Установить webhook"),9,le),e("button",{onClick:x=>t.handleEditBot(r),class:"px-3 py-2 text-xs bg-yellow-500/10 hover:bg-yellow-500/20 text-yellow-500 rounded-lg transition-colors"}," Редактировать ",8,ae),e("button",{onClick:x=>t.handleDeleteBot(r),class:"px-3 py-2 text-xs bg-red-500/10 hover:bg-red-500/20 text-red-500 rounded-lg transition-colors"}," Удалить ",8,ie)])]))),128))])):g("",!0),!t.loading&&t.bots.length===0?(u(),d("div",de,[...o[16]||(o[16]=[e("p",{class:"text-muted-foreground"},"Боты не найдены. Добавьте первого бота.",-1)])])):g("",!0),t.showCreateModal||t.showEditModal?(u(),d("div",ce,[e("div",ue,[e("div",ge,[e("h3",be,c(t.showEditModal?"Редактировать бота":"Добавить бота"),1)]),e("form",{onSubmit:o[10]||(o[10]=J((...r)=>t.handleSaveBot&&t.handleSaveBot(...r),["prevent"])),class:"p-6 space-y-4"},[e("div",null,[o[17]||(o[17]=e("label",{class:"text-sm font-medium mb-1 block"},"Название бота *",-1)),k(e("input",{"onUpdate:modelValue":o[1]||(o[1]=r=>t.form.name=r),type:"text",required:"",placeholder:"Мой бот",class:"w-full h-10 px-3 border border-border rounded bg-background focus:outline-none focus:ring-2 focus:ring-ring"},null,512),[[w,t.form.name]])]),e("div",null,[o[18]||(o[18]=e("label",{class:"text-sm font-medium mb-1 block"},"Токен бота *",-1)),k(e("input",{"onUpdate:modelValue":o[2]||(o[2]=r=>t.form.token=r),type:"text",required:"",placeholder:"1234567890:ABCdefGHIjklMNOpqrsTUVwxyz",class:"w-full h-10 px-3 border border-border rounded bg-background focus:outline-none focus:ring-2 focus:ring-ring font-mono text-sm"},null,512),[[w,t.form.token]]),o[19]||(o[19]=e("p",{class:"text-xs text-muted-foreground mt-1"},"Получить токен можно у @BotFather",-1))]),e("div",null,[o[20]||(o[20]=e("label",{class:"text-sm font-medium mb-1 block"},"Приветственное сообщение",-1)),k(e("textarea",{"onUpdate:modelValue":o[3]||(o[3]=r=>t.form.welcome_message=r),rows:"4",placeholder:"Добро пожаловать! Это приветственное сообщение...",class:"w-full px-3 py-2 border border-border rounded bg-background focus:outline-none focus:ring-2 focus:ring-ring resize-none"},null,512),[[w,t.form.welcome_message]])]),e("div",null,[o[22]||(o[22]=e("label",{class:"text-sm font-medium mb-1 block"},"Активен",-1)),e("label",me,[k(e("input",{"onUpdate:modelValue":o[4]||(o[4]=r=>t.form.is_active=r),type:"checkbox",class:"w-4 h-4"},null,512),[[R,t.form.is_active]]),o[21]||(o[21]=e("span",{class:"text-sm"},"Бот активен",-1))])]),t.showEditModal?(u(),d("div",fe,[e("div",null,[o[26]||(o[26]=e("label",{class:"text-sm font-medium mb-2 block"},"Настройки Webhook",-1)),e("div",ke,[e("div",null,[o[23]||(o[23]=e("label",{class:"text-xs text-muted-foreground mb-1 block"},"Разрешенные обновления (через запятую)",-1)),k(e("input",{"onUpdate:modelValue":o[5]||(o[5]=r=>t.form.webhook_allowed_updates=r),type:"text",placeholder:"message, callback_query, inline_query",class:"w-full h-10 px-3 border border-border rounded bg-background focus:outline-none focus:ring-2 focus:ring-ring text-sm"},null,512),[[w,t.form.webhook_allowed_updates]])]),e("div",null,[o[24]||(o[24]=e("label",{class:"text-xs text-muted-foreground mb-1 block"},"Максимальное количество соединений (1-100)",-1)),k(e("input",{"onUpdate:modelValue":o[6]||(o[6]=r=>t.form.webhook_max_connections=r),type:"number",min:"1",max:"100",placeholder:"40",class:"w-full h-10 px-3 border border-border rounded bg-background focus:outline-none focus:ring-2 focus:ring-ring text-sm"},null,512),[[w,t.form.webhook_max_connections,void 0,{number:!0}]])]),e("div",null,[o[25]||(o[25]=e("label",{class:"text-xs text-muted-foreground mb-1 block"},"Secret Token (опционально)",-1)),k(e("input",{"onUpdate:modelValue":o[7]||(o[7]=r=>t.form.webhook_secret_token=r),type:"text",placeholder:"Секретный токен для проверки webhook",class:"w-full h-10 px-3 border border-border rounded bg-background focus:outline-none focus:ring-2 focus:ring-ring text-sm font-mono"},null,512),[[w,t.form.webhook_secret_token]])])])]),e("div",null,[o[27]||(o[27]=e("label",{class:"text-sm font-medium mb-1 block"},"Дополнительные настройки (JSON)",-1)),k(e("textarea",{"onUpdate:modelValue":o[8]||(o[8]=r=>t.settingsJson=r),rows:"6",placeholder:'{"key": "value"}',class:"w-full px-3 py-2 border border-border rounded bg-background focus:outline-none focus:ring-2 focus:ring-ring resize-none font-mono text-sm"},null,512),[[w,t.settingsJson]]),o[28]||(o[28]=e("p",{class:"text-xs text-muted-foreground mt-1"},"Дополнительные настройки бота в формате JSON",-1))])])):g("",!0),e("div",he,[e("button",{type:"button",onClick:o[9]||(o[9]=(...r)=>t.handleCloseModal&&t.handleCloseModal(...r)),class:"flex-1 h-10 px-4 border border-border bg-background/50 hover:bg-accent/10 rounded-lg transition-colors"}," Отмена "),e("button",{type:"submit",disabled:t.saving,class:"flex-1 h-10 px-4 bg-accent/10 backdrop-blur-xl text-accent border border-accent/40 hover:bg-accent/20 rounded-lg transition-colors disabled:opacity-50"},c(t.saving?"Сохранение...":"Сохранить"),9,xe)])],32)])])):g("",!0),t.webhookInfo?(u(),d("div",we,[e("div",ve,[e("div",pe,[o[33]||(o[33]=e("h3",{class:"text-lg font-semibold mb-4"},"Информация о webhook",-1)),e("div",_e,[e("div",null,[o[29]||(o[29]=e("span",{class:"text-sm font-medium text-muted-foreground"},"URL:",-1)),e("p",ye,c(t.webhookInfo.url||"Не установлен"),1)]),e("div",null,[o[30]||(o[30]=e("span",{class:"text-sm font-medium text-muted-foreground"},"Ожидающие обновления:",-1)),e("p",Be,c(t.webhookInfo.pending_update_count||0),1)]),t.webhookInfo.last_error_message?(u(),d("div",Ce,[o[31]||(o[31]=e("span",{class:"text-sm font-medium text-muted-foreground"},"Последняя ошибка:",-1)),e("p",Ee,c(t.webhookInfo.last_error_message),1)])):g("",!0),t.webhookInfo.max_connections?(u(),d("div",Se,[o[32]||(o[32]=e("span",{class:"text-sm font-medium text-muted-foreground"},"Макс. соединений:",-1)),e("p",We,c(t.webhookInfo.max_connections),1)])):g("",!0)]),e("button",{onClick:o[11]||(o[11]=r=>t.webhookInfo=null),class:"w-full mt-4 h-10 px-4 bg-accent/10 backdrop-blur-xl text-accent border border-accent/40 hover:bg-accent/20 rounded-lg transition-colors"}," Закрыть ")])])])):g("",!0)])}const Ie=V(G,[["render",Me]]);export{Ie as default};
