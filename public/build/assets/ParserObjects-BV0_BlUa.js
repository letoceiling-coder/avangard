import{b as y,d as v,c as h}from"./api-BACpyIk9.js";import{_,c as a,a as e,b as u,F as b,q as f,d as p,v as k,I as x,A as w,t as d,o as c,p as m}from"./admin-Blbw7igg.js";const j={name:"ParserObjects",data(){return{loading:!1,error:null,currentType:"blocks",objects:[],cities:[],pagination:null,filters:{search:"",city_id:"",data_source:"",is_active:""},objectTypes:[{value:"blocks",label:"Квартиры",endpoint:"/blocks"},{value:"parkings",label:"Паркинги",endpoint:"/parkings"},{value:"villages",label:"Поселки",endpoint:"/villages"},{value:"plots",label:"Участки",endpoint:"/plots"},{value:"commercial-blocks",label:"Коммерческие объекты",endpoint:"/commercial-blocks"},{value:"commercial-premises",label:"Коммерческие помещения",endpoint:"/commercial-premises"}],debounceTimer:null,checkingActuality:null}},async mounted(){await this.fetchCities(),await this.fetchObjects()},methods:{async fetchCities(){try{const t=await(await h("/regions")).json();if(t.data){const l=[];t.data.forEach(n=>{n.cities&&l.push(...n.cities)}),this.cities=l}}catch(i){console.error("Error fetching cities:",i)}},async fetchObjects(i=1){this.loading=!0,this.error=null;try{const t=this.objectTypes.find(r=>r.value===this.currentType),l={page:i,per_page:15,...this.filters};Object.keys(l).forEach(r=>{(l[r]===""||l[r]===null)&&delete l[r]});const n=await h(t.endpoint,l),s=await n.json();n.ok?(this.objects=s.data||[],this.pagination={current_page:s.current_page||1,last_page:s.last_page||1,from:s.from||0,to:s.to||0,total:s.total||0}):this.error=s.message||"Ошибка при загрузке объектов"}catch(t){console.error("Error fetching objects:",t),this.error="Ошибка при загрузке объектов"}finally{this.loading=!1}},debouncedFetchObjects(){clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{this.fetchObjects()},500)},changePage(i){this.fetchObjects(i)},viewObject(i){console.log("View object:",i)},editObject(i){console.log("Edit object:",i)},async deleteObject(i){if(confirm(`Вы уверены, что хотите удалить объект "${i.name}"?`))try{const t=this.objectTypes.find(n=>n.value===this.currentType),l=await v(`${t.endpoint}/${i.id}`);if(l.ok)await this.fetchObjects(this.pagination.current_page);else{const n=await l.json();alert(n.message||"Ошибка при удалении объекта")}}catch(t){console.error("Error deleting object:",t),alert("Ошибка при удалении объекта")}},getDataSourceLabel(i){return{parser:"Парсер",manual:"Вручную",feed:"Feed",import:"Импорт"}[i]||i},async checkActuality(i){if(this.checkingActuality!==i.id){this.checkingActuality=i.id;try{const t=this.objectTypes.find(s=>s.value===this.currentType);if(this.currentType!=="blocks"){alert("Проверка актуальности пока доступна только для блоков (квартир)"),this.checkingActuality=null;return}const l=await y(`/blocks/${i.id}/check-actuality`,{update:!0}),n=await l.json();if(l.ok)if(n.data&&n.data.actual)alert("✅ Данные актуальны");else if(n.data&&n.data.updated){const s=n.data.changes&&n.data.changes.length>0?n.data.changes.map(r=>r.field||r).join(", "):"Нет данных о изменениях";alert("✅ Данные обновлены. Обнаружены изменения: "+s),await this.fetchObjects(this.pagination.current_page)}else if(n.data&&n.data.changes&&n.data.changes.length>0){const s=n.data.changes.map(r=>r.field||r).join(", ");alert("⚠️ Обнаружены изменения: "+s)}else alert(n.message||"Проверка завершена");else alert(n.message||"Ошибка при проверке актуальности")}catch(t){console.error("Error checking actuality:",t),alert("Ошибка при проверке актуальности: "+(t.message||"Неизвестная ошибка"))}finally{this.checkingActuality=null}}}}},O={class:"parser-objects-page space-y-6"},C={class:"bg-card rounded-lg border border-border p-4 mb-6"},T={class:"flex flex-wrap gap-2"},A=["onClick"],D={class:"bg-card rounded-lg border border-border p-4 mb-6"},E={class:"grid grid-cols-1 md:grid-cols-4 gap-4"},V=["value"],F={key:0,class:"flex items-center justify-center py-12"},P={key:1,class:"p-4 bg-destructive/10 border border-destructive/20 rounded-lg"},S={class:"text-destructive"},U={key:2,class:"bg-card rounded-lg border border-border overflow-hidden"},L={class:"overflow-x-auto"},B={class:"w-full"},I={class:"divide-y divide-border"},N={class:"px-6 py-4 text-sm text-foreground"},M={class:"px-6 py-4 text-sm font-medium text-foreground"},q={class:"px-6 py-4 text-sm text-foreground"},z={class:"px-6 py-4 text-sm text-foreground"},G={class:"px-6 py-4 text-sm text-foreground"},R={class:"px-6 py-4 text-sm text-foreground"},H={class:"px-6 py-4 text-sm text-muted-foreground"},J={class:"px-6 py-4 text-sm text-right"},K={class:"flex items-center justify-end gap-2"},Q=["onClick","disabled"],W=["onClick"],X=["onClick"],Y=["onClick"],Z={key:3,class:"bg-card rounded-lg border border-border p-12 text-center"},$={key:4,class:"flex items-center justify-between bg-card rounded-lg border border-border p-4"},ee={class:"text-sm text-muted-foreground"},te={class:"flex gap-2"},se=["disabled"],oe=["disabled"];function re(i,t,l,n,s,r){return c(),a("div",O,[t[20]||(t[20]=e("div",{class:"flex items-center justify-between mb-6"},[e("div",null,[e("h1",{class:"text-3xl font-semibold text-foreground"},"Объекты парсера"),e("p",{class:"text-muted-foreground mt-1"},"Просмотр и управление объектами из парсера TrendAgent")])],-1)),e("div",C,[e("div",T,[(c(!0),a(b,null,f(s.objectTypes,o=>(c(),a("button",{key:o.value,onClick:g=>{s.currentType=o.value,r.fetchObjects()},class:m(["px-4 py-2 rounded-lg text-sm font-medium transition-colors",s.currentType===o.value?"bg-accent text-accent-foreground":"bg-muted text-muted-foreground hover:bg-muted/80"])},d(o.label),11,A))),128))])]),e("div",D,[e("div",E,[e("div",null,[t[10]||(t[10]=e("label",{class:"block text-sm font-medium text-foreground mb-2"},"Поиск",-1)),p(e("input",{"onUpdate:modelValue":t[0]||(t[0]=o=>s.filters.search=o),onInput:t[1]||(t[1]=(...o)=>r.debouncedFetchObjects&&r.debouncedFetchObjects(...o)),type:"text",placeholder:"Название или адрес...",class:"w-full h-10 px-3 border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-ring"},null,544),[[k,s.filters.search]])]),e("div",null,[t[12]||(t[12]=e("label",{class:"block text-sm font-medium text-foreground mb-2"},"Город",-1)),p(e("select",{"onUpdate:modelValue":t[2]||(t[2]=o=>s.filters.city_id=o),onChange:t[3]||(t[3]=(...o)=>r.fetchObjects&&r.fetchObjects(...o)),class:"w-full h-10 px-3 border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-ring"},[t[11]||(t[11]=e("option",{value:""},"Все города",-1)),(c(!0),a(b,null,f(s.cities,o=>(c(),a("option",{key:o.id,value:o.id},d(o.name),9,V))),128))],544),[[x,s.filters.city_id]])]),e("div",null,[t[14]||(t[14]=e("label",{class:"block text-sm font-medium text-foreground mb-2"},"Источник",-1)),p(e("select",{"onUpdate:modelValue":t[4]||(t[4]=o=>s.filters.data_source=o),onChange:t[5]||(t[5]=(...o)=>r.fetchObjects&&r.fetchObjects(...o)),class:"w-full h-10 px-3 border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-ring"},[...t[13]||(t[13]=[w('<option value="">Все источники</option><option value="parser">Парсер</option><option value="manual">Вручную</option><option value="feed">Feed</option><option value="import">Импорт</option>',5)])],544),[[x,s.filters.data_source]])]),e("div",null,[t[16]||(t[16]=e("label",{class:"block text-sm font-medium text-foreground mb-2"},"Статус",-1)),p(e("select",{"onUpdate:modelValue":t[6]||(t[6]=o=>s.filters.is_active=o),onChange:t[7]||(t[7]=(...o)=>r.fetchObjects&&r.fetchObjects(...o)),class:"w-full h-10 px-3 border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-ring"},[...t[15]||(t[15]=[e("option",{value:""},"Все",-1),e("option",{value:"1"},"Активные",-1),e("option",{value:"0"},"Неактивные",-1)])],544),[[x,s.filters.is_active]])])])]),s.loading?(c(),a("div",F,[...t[17]||(t[17]=[e("p",{class:"text-muted-foreground"},"Загрузка объектов...",-1)])])):u("",!0),s.error?(c(),a("div",P,[e("p",S,d(s.error),1)])):u("",!0),!s.loading&&s.objects.length>0?(c(),a("div",U,[e("div",L,[e("table",B,[t[18]||(t[18]=e("thead",{class:"bg-muted/30 border-b border-border"},[e("tr",null,[e("th",{class:"px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase"},"ID"),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase"},"Название"),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase"},"Адрес"),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase"},"Город"),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase"},"Источник"),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase"},"Статус"),e("th",{class:"px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase"},"Обновлено"),e("th",{class:"px-6 py-3 text-right text-xs font-medium text-muted-foreground uppercase"},"Действия")])],-1)),e("tbody",I,[(c(!0),a(b,null,f(s.objects,o=>(c(),a("tr",{key:o.id,class:"hover:bg-muted/10"},[e("td",N,d(o.id),1),e("td",M,d(o.name),1),e("td",q,d(o.address||"-"),1),e("td",z,d(o.city?.name||"-"),1),e("td",G,[e("span",{class:m(["px-2 py-1 text-xs rounded-md",o.data_source==="parser"?"bg-blue-500/10 text-blue-500":"bg-gray-500/10 text-gray-500"])},d(r.getDataSourceLabel(o.data_source)),3)]),e("td",R,[e("span",{class:m(["px-2 py-1 text-xs rounded-md",o.is_active?"bg-green-500/10 text-green-500":"bg-red-500/10 text-red-500"])},d(o.is_active?"Активен":"Неактивен"),3)]),e("td",H,d(o.updated_at?new Date(o.updated_at).toLocaleDateString("ru-RU"):"-"),1),e("td",J,[e("div",K,[e("button",{onClick:g=>r.checkActuality(o),disabled:s.checkingActuality===o.id,class:"px-3 py-1 text-xs bg-yellow-500 hover:bg-yellow-600 text-white rounded transition-colors disabled:opacity-50 disabled:cursor-not-allowed",title:"Проверить актуальность данных"},d(s.checkingActuality===o.id?"Проверка...":"Проверить актуальность"),9,Q),e("button",{onClick:g=>r.viewObject(o),class:"px-3 py-1 text-xs bg-blue-500 hover:bg-blue-600 text-white rounded transition-colors"}," Просмотр ",8,W),e("button",{onClick:g=>r.editObject(o),class:"px-3 py-1 text-xs bg-green-500 hover:bg-green-600 text-white rounded transition-colors"}," Редактировать ",8,X),e("button",{onClick:g=>r.deleteObject(o),class:"px-3 py-1 text-xs bg-red-500 hover:bg-red-600 text-white rounded transition-colors"}," Удалить ",8,Y)])])]))),128))])])])])):u("",!0),!s.loading&&s.objects.length===0?(c(),a("div",Z,[...t[19]||(t[19]=[e("p",{class:"text-muted-foreground"},"Объекты не найдены",-1)])])):u("",!0),!s.loading&&s.pagination&&s.pagination.last_page>1?(c(),a("div",$,[e("div",ee," Показано "+d(s.pagination.from)+" - "+d(s.pagination.to)+" из "+d(s.pagination.total),1),e("div",te,[e("button",{onClick:t[8]||(t[8]=o=>r.changePage(s.pagination.current_page-1)),disabled:s.pagination.current_page===1,class:"px-4 py-2 text-sm border border-border rounded-lg hover:bg-muted/10 disabled:opacity-50 disabled:cursor-not-allowed"}," Назад ",8,se),e("button",{onClick:t[9]||(t[9]=o=>r.changePage(s.pagination.current_page+1)),disabled:s.pagination.current_page===s.pagination.last_page,class:"px-4 py-2 text-sm border border-border rounded-lg hover:bg-muted/10 disabled:opacity-50 disabled:cursor-not-allowed"}," Вперед ",8,oe)])])):u("",!0)])}const le=_(j,[["render",re]]);export{le as default};
