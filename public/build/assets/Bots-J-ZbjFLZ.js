import{_ as S,c,a as e,b,t as i,F as E,q as D,w as N,d as g,v as w,N as J,r as m,m as z,k as O,o as u,p as C}from"./admin-CsXzdZkw.js";import{c as j,b as q,a as A,d as F}from"./api-BACpyIk9.js";import{S as f}from"./sweetalert2.esm.all-C0u8rGqG.js";const G={name:"Bots",setup(){const h=m(!1),o=m(!1),v=m(null),t=m([]),p=m(!1),x=m(!1),s=m(null),k=m(null),y=m(null),a=m({id:null,name:"",token:"",welcome_message:"",is_active:!0,settings:{},webhook_allowed_updates:"message, callback_query",webhook_max_connections:40,webhook_secret_token:""}),M=z({get:()=>JSON.stringify(a.value.settings||{},null,2),set:n=>{try{a.value.settings=JSON.parse(n||"{}")}catch{}}}),_=async()=>{h.value=!0,v.value=null;try{const n=await j("/v1/bots");if(!n.ok)throw new Error("Ошибка загрузки ботов");const l=await n.json();t.value=l.data||[]}catch(n){v.value=n.message||"Ошибка загрузки ботов"}finally{h.value=!1}},W=n=>{const l=n.settings||{},r=l.webhook||{};a.value={id:n.id,name:n.name,token:n.token,welcome_message:n.welcome_message||"",is_active:n.is_active??!0,settings:l,webhook_allowed_updates:Array.isArray(r.allowed_updates)?r.allowed_updates.join(", "):r.allowed_updates||"message, callback_query",webhook_max_connections:r.max_connections||40,webhook_secret_token:r.secret_token||""},x.value=!0},T=async n=>{if((await f.fire({title:"Удалить бота?",html:`Вы уверены, что хотите удалить бота <strong>"${n.name}"</strong>?`,icon:"warning",showCancelButton:!0,confirmButtonText:"Да, удалить",cancelButtonText:"Отмена",confirmButtonColor:"#dc2626",cancelButtonColor:"#6b7280"})).isConfirmed)try{const r=await F(`/v1/bots/${n.id}`);if(!r.ok){const d=await r.json();throw new Error(d.message||"Ошибка удаления бота")}await f.fire({title:"Бот удален",icon:"success",timer:2e3,showConfirmButton:!1,toast:!0,position:"top-end"}),await _()}catch(r){f.fire({title:"Ошибка",text:r.message||"Ошибка удаления бота",icon:"error",confirmButtonText:"ОК"})}},U=async()=>{o.value=!0,v.value=null;try{const n={name:a.value.name,token:a.value.token,welcome_message:a.value.welcome_message,is_active:a.value.is_active},l=a.value.webhook_allowed_updates.split(",").map(d=>d.trim()).filter(d=>d);if(n.webhook={allowed_updates:l,max_connections:a.value.webhook_max_connections||40},a.value.webhook_secret_token&&(n.webhook.secret_token=a.value.webhook_secret_token),x.value){const d={...a.value.settings,webhook:n.webhook};n.settings=d}let r;if(x.value?r=await A(`/v1/bots/${a.value.id}`,n):r=await q("/v1/bots",n),!r.ok){const d=await r.json();throw new Error(d.message||"Ошибка сохранения бота")}await f.fire({title:x.value?"Бот обновлен":"Бот создан",icon:"success",timer:2e3,showConfirmButton:!1,toast:!0,position:"top-end"}),B(),await _()}catch(n){v.value=n.message||"Ошибка сохранения бота",f.fire({title:"Ошибка",text:n.message||"Ошибка сохранения бота",icon:"error",confirmButtonText:"ОК"})}finally{o.value=!1}},V=async n=>{s.value=n.id;try{const l=await j(`/v1/bots/${n.id}/check-webhook`);if(!l.ok){const d=await l.json();throw new Error(d.message||"Ошибка проверки webhook")}const r=await l.json();y.value=r.data?.data||r.data||{}}catch(l){f.fire({title:"Ошибка",text:l.message||"Ошибка проверки webhook",icon:"error",confirmButtonText:"ОК"})}finally{s.value=null}},I=async n=>{k.value=n.id;try{const l=await q(`/v1/bots/${n.id}/register-webhook`);if(!l.ok){const d=await l.json();throw new Error(d.message||"Ошибка регистрации webhook")}const r=await l.json();await f.fire({title:r.success?"Webhook установлен":"Ошибка",text:r.message||(r.success?"Webhook успешно установлен":"Не удалось установить webhook"),icon:r.success?"success":"error",confirmButtonText:"ОК"}),await _()}catch(l){f.fire({title:"Ошибка",text:l.message||"Ошибка регистрации webhook",icon:"error",confirmButtonText:"ОК"})}finally{k.value=null}},B=()=>{p.value=!1,x.value=!1,a.value={id:null,name:"",token:"",welcome_message:"",is_active:!0,settings:{},webhook_allowed_updates:"message, callback_query",webhook_max_connections:40,webhook_secret_token:""}};return O(async()=>{await _()}),{loading:h,saving:o,error:v,bots:t,showCreateModal:p,showEditModal:x,form:a,settingsJson:M,checkingWebhook:s,registeringWebhook:k,webhookInfo:y,editBot:W,deleteBot:T,saveBot:U,checkWebhook:V,registerWebhook:I,closeModal:B}}},L={class:"bots-page space-y-6"},P={class:"flex items-center justify-between mb-6"},H={key:0,class:"flex items-center justify-center py-12"},R={key:1,class:"p-4 bg-destructive/10 border border-destructive/20 rounded-lg"},K={class:"text-destructive"},Q={key:2,class:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"},X={class:"flex items-start justify-between mb-4"},Y={class:"text-lg font-semibold text-foreground"},Z={key:0,class:"text-sm text-muted-foreground"},$={class:"space-y-2 mb-4"},ee={class:"flex items-center justify-between text-sm"},oe=["title"],te={class:"flex flex-wrap gap-2"},se=["onClick","disabled"],ne=["onClick","disabled"],re=["onClick"],le=["onClick"],ae={key:3,class:"bg-card rounded-lg border border-border p-12 text-center"},ie={key:4,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4"},de={class:"bg-background border border-border rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto"},ce={class:"sticky top-0 bg-background border-b border-border p-6"},ue={class:"text-lg font-semibold"},be={class:"flex items-center gap-2 cursor-pointer"},me={class:"space-y-4"},ge={class:"space-y-3"},fe={class:"flex gap-2 pt-4 border-t border-border"},xe=["disabled"],ke={key:5,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4"},we={class:"bg-background border border-border rounded-lg shadow-2xl w-full max-w-md"},ve={class:"p-6"},he={class:"space-y-3"},_e={class:"text-sm text-foreground break-all"},pe={class:"text-sm text-foreground"},ye={key:0},Be={class:"text-sm text-red-500"},Ce={key:1},je={class:"text-sm text-foreground"};function qe(h,o,v,t,p,x){return u(),c("div",L,[e("div",P,[o[13]||(o[13]=e("div",null,[e("h1",{class:"text-3xl font-semibold text-foreground"},"Боты"),e("p",{class:"text-muted-foreground mt-1"},"Управление Telegram ботами")],-1)),e("button",{onClick:o[0]||(o[0]=s=>t.showCreateModal=!0),class:"h-11 px-6 bg-accent/10 backdrop-blur-xl text-accent border border-accent/40 hover:bg-accent/20 rounded-2xl shadow-lg shadow-accent/10 inline-flex items-center justify-center gap-2"},[...o[12]||(o[12]=[e("span",null,"+",-1),e("span",null,"Добавить бота",-1)])])]),t.loading?(u(),c("div",H,[...o[14]||(o[14]=[e("p",{class:"text-muted-foreground"},"Загрузка ботов...",-1)])])):b("",!0),t.error?(u(),c("div",R,[e("p",K,i(t.error),1)])):b("",!0),!t.loading&&t.bots.length>0?(u(),c("div",Q,[(u(!0),c(E,null,D(t.bots,s=>(u(),c("div",{key:s.id,class:"bg-card rounded-lg border border-border p-6 hover:shadow-lg transition-shadow"},[e("div",X,[e("div",null,[e("h3",Y,i(s.name),1),s.username?(u(),c("p",Z,"@"+i(s.username),1)):b("",!0)]),e("span",{class:C(["px-2 py-1 text-xs rounded-md",s.is_active?"bg-green-500/10 text-green-500":"bg-gray-500/10 text-gray-500"])},i(s.is_active?"Активен":"Неактивен"),3)]),e("div",$,[e("div",ee,[o[15]||(o[15]=e("span",{class:"text-muted-foreground"},"Webhook:",-1)),e("span",{class:C(["px-2 py-1 text-xs rounded-md",s.webhook_registered?"bg-green-500/10 text-green-500":"bg-red-500/10 text-red-500"])},i(s.webhook_registered?"Установлен":"Не установлен"),3)]),s.webhook_url?(u(),c("div",{key:0,class:"text-xs text-muted-foreground truncate",title:s.webhook_url},i(s.webhook_url),9,oe)):b("",!0)]),e("div",te,[e("button",{onClick:k=>t.checkWebhook(s),disabled:t.checkingWebhook===s.id,class:"flex-1 px-3 py-2 text-xs bg-blue-500/10 hover:bg-blue-500/20 text-blue-500 rounded-lg transition-colors disabled:opacity-50"},i(t.checkingWebhook===s.id?"Проверка...":"Проверить webhook"),9,se),e("button",{onClick:k=>t.registerWebhook(s),disabled:t.registeringWebhook===s.id,class:"flex-1 px-3 py-2 text-xs bg-green-500/10 hover:bg-green-500/20 text-green-500 rounded-lg transition-colors disabled:opacity-50"},i(t.registeringWebhook===s.id?"Регистрация...":"Установить webhook"),9,ne),e("button",{onClick:k=>t.editBot(s),class:"px-3 py-2 text-xs bg-yellow-500/10 hover:bg-yellow-500/20 text-yellow-500 rounded-lg transition-colors"}," Редактировать ",8,re),e("button",{onClick:k=>t.deleteBot(s),class:"px-3 py-2 text-xs bg-red-500/10 hover:bg-red-500/20 text-red-500 rounded-lg transition-colors"}," Удалить ",8,le)])]))),128))])):b("",!0),!t.loading&&t.bots.length===0?(u(),c("div",ae,[...o[16]||(o[16]=[e("p",{class:"text-muted-foreground"},"Боты не найдены. Добавьте первого бота.",-1)])])):b("",!0),t.showCreateModal||t.showEditModal?(u(),c("div",ie,[e("div",de,[e("div",ce,[e("h3",ue,i(t.showEditModal?"Редактировать бота":"Добавить бота"),1)]),e("form",{onSubmit:o[10]||(o[10]=N((...s)=>t.saveBot&&t.saveBot(...s),["prevent"])),class:"p-6 space-y-4"},[e("div",null,[o[17]||(o[17]=e("label",{class:"text-sm font-medium mb-1 block"},"Название бота *",-1)),g(e("input",{"onUpdate:modelValue":o[1]||(o[1]=s=>t.form.name=s),type:"text",required:"",placeholder:"Мой бот",class:"w-full h-10 px-3 border border-border rounded bg-background focus:outline-none focus:ring-2 focus:ring-ring"},null,512),[[w,t.form.name]])]),e("div",null,[o[18]||(o[18]=e("label",{class:"text-sm font-medium mb-1 block"},"Токен бота *",-1)),g(e("input",{"onUpdate:modelValue":o[2]||(o[2]=s=>t.form.token=s),type:"text",required:"",placeholder:"1234567890:ABCdefGHIjklMNOpqrsTUVwxyz",class:"w-full h-10 px-3 border border-border rounded bg-background focus:outline-none focus:ring-2 focus:ring-ring font-mono text-sm"},null,512),[[w,t.form.token]]),o[19]||(o[19]=e("p",{class:"text-xs text-muted-foreground mt-1"},"Получить токен можно у @BotFather",-1))]),e("div",null,[o[20]||(o[20]=e("label",{class:"text-sm font-medium mb-1 block"},"Приветственное сообщение",-1)),g(e("textarea",{"onUpdate:modelValue":o[3]||(o[3]=s=>t.form.welcome_message=s),rows:"4",placeholder:"Добро пожаловать! Это приветственное сообщение...",class:"w-full px-3 py-2 border border-border rounded bg-background focus:outline-none focus:ring-2 focus:ring-ring resize-none"},null,512),[[w,t.form.welcome_message]])]),e("div",null,[o[22]||(o[22]=e("label",{class:"text-sm font-medium mb-1 block"},"Активен",-1)),e("label",be,[g(e("input",{"onUpdate:modelValue":o[4]||(o[4]=s=>t.form.is_active=s),type:"checkbox",class:"w-4 h-4"},null,512),[[J,t.form.is_active]]),o[21]||(o[21]=e("span",{class:"text-sm"},"Бот активен",-1))])]),e("div",me,[e("div",null,[o[27]||(o[27]=e("label",{class:"text-sm font-medium mb-2 block"},"Настройки Webhook",-1)),e("div",ge,[e("div",null,[o[23]||(o[23]=e("label",{class:"text-xs text-muted-foreground mb-1 block"},"Разрешенные обновления (через запятую)",-1)),g(e("input",{"onUpdate:modelValue":o[5]||(o[5]=s=>t.form.webhook_allowed_updates=s),type:"text",placeholder:"message, callback_query, inline_query",class:"w-full h-10 px-3 border border-border rounded bg-background focus:outline-none focus:ring-2 focus:ring-ring text-sm"},null,512),[[w,t.form.webhook_allowed_updates]]),o[24]||(o[24]=e("p",{class:"text-xs text-muted-foreground mt-1"},"Доступные: message, edited_message, channel_post, edited_channel_post, callback_query, inline_query, chosen_inline_result, shipping_query, pre_checkout_query, poll, poll_answer, my_chat_member, chat_member, chat_join_request",-1))]),e("div",null,[o[25]||(o[25]=e("label",{class:"text-xs text-muted-foreground mb-1 block"},"Максимальное количество соединений (1-100)",-1)),g(e("input",{"onUpdate:modelValue":o[6]||(o[6]=s=>t.form.webhook_max_connections=s),type:"number",min:"1",max:"100",placeholder:"40",class:"w-full h-10 px-3 border border-border rounded bg-background focus:outline-none focus:ring-2 focus:ring-ring text-sm"},null,512),[[w,t.form.webhook_max_connections,void 0,{number:!0}]])]),e("div",null,[o[26]||(o[26]=e("label",{class:"text-xs text-muted-foreground mb-1 block"},"Secret Token (опционально)",-1)),g(e("input",{"onUpdate:modelValue":o[7]||(o[7]=s=>t.form.webhook_secret_token=s),type:"text",placeholder:"Секретный токен для проверки webhook",class:"w-full h-10 px-3 border border-border rounded bg-background focus:outline-none focus:ring-2 focus:ring-ring text-sm font-mono"},null,512),[[w,t.form.webhook_secret_token]])])])]),e("div",null,[o[28]||(o[28]=e("label",{class:"text-sm font-medium mb-1 block"},"Дополнительные настройки (JSON)",-1)),g(e("textarea",{"onUpdate:modelValue":o[8]||(o[8]=s=>t.settingsJson=s),rows:"6",placeholder:'{"key": "value"}',class:"w-full px-3 py-2 border border-border rounded bg-background focus:outline-none focus:ring-2 focus:ring-ring resize-none font-mono text-sm"},null,512),[[w,t.settingsJson]]),o[29]||(o[29]=e("p",{class:"text-xs text-muted-foreground mt-1"},"Дополнительные настройки бота в формате JSON",-1))])]),e("div",fe,[e("button",{type:"button",onClick:o[9]||(o[9]=(...s)=>t.closeModal&&t.closeModal(...s)),class:"flex-1 h-10 px-4 border border-border bg-background/50 hover:bg-accent/10 rounded-lg transition-colors"}," Отмена "),e("button",{type:"submit",disabled:t.saving,class:"flex-1 h-10 px-4 bg-accent/10 backdrop-blur-xl text-accent border border-accent/40 hover:bg-accent/20 rounded-lg transition-colors disabled:opacity-50"},i(t.saving?"Сохранение...":"Сохранить"),9,xe)])],32)])])):b("",!0),t.webhookInfo?(u(),c("div",ke,[e("div",we,[e("div",ve,[o[34]||(o[34]=e("h3",{class:"text-lg font-semibold mb-4"},"Информация о webhook",-1)),e("div",he,[e("div",null,[o[30]||(o[30]=e("span",{class:"text-sm font-medium text-muted-foreground"},"URL:",-1)),e("p",_e,i(t.webhookInfo.url||"Не установлен"),1)]),e("div",null,[o[31]||(o[31]=e("span",{class:"text-sm font-medium text-muted-foreground"},"Ожидающие обновления:",-1)),e("p",pe,i(t.webhookInfo.pending_update_count||0),1)]),t.webhookInfo.last_error_message?(u(),c("div",ye,[o[32]||(o[32]=e("span",{class:"text-sm font-medium text-muted-foreground"},"Последняя ошибка:",-1)),e("p",Be,i(t.webhookInfo.last_error_message),1)])):b("",!0),t.webhookInfo.max_connections?(u(),c("div",Ce,[o[33]||(o[33]=e("span",{class:"text-sm font-medium text-muted-foreground"},"Макс. соединений:",-1)),e("p",je,i(t.webhookInfo.max_connections),1)])):b("",!0)]),e("button",{onClick:o[11]||(o[11]=s=>t.webhookInfo=null),class:"w-full mt-4 h-10 px-4 bg-accent/10 backdrop-blur-xl text-accent border border-accent/40 hover:bg-accent/20 rounded-lg transition-colors"}," Закрыть ")])])])):b("",!0)])}const Ue=S(G,[["render",qe]]);export{Ue as default};
