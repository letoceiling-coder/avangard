import{b as y,d as v,c as h}from"./api-BACpyIk9.js";import{_,c as d,a as t,b as u,F as b,q as f,d as g,v as k,I as m,A as w,t as a,o as c,p as x}from"./admin-B3aLB-lk.js";const j={name:"ParserObjects",data(){return{loading:!1,error:null,currentType:"blocks",objects:[],cities:[],pagination:null,filters:{search:"",city_id:"",data_source:"",is_active:""},objectTypes:[{value:"blocks",label:"Квартиры",endpoint:"/blocks"},{value:"parkings",label:"Паркинги",endpoint:"/parkings"},{value:"villages",label:"Поселки",endpoint:"/villages"},{value:"plots",label:"Участки",endpoint:"/plots"},{value:"commercial-blocks",label:"Коммерческие объекты",endpoint:"/commercial-blocks"},{value:"commercial-premises",label:"Коммерческие помещения",endpoint:"/commercial-premises"}],debounceTimer:null,checkingActuality:null}},async mounted(){await this.fetchCities(),await this.fetchObjects()},methods:{async fetchCities(){try{const e=await(await h("/regions")).json();if(e.data){const l=[];e.data.forEach(n=>{n.cities&&l.push(...n.cities)}),this.cities=l}}catch(i){console.error("Error fetching cities:",i)}},async fetchObjects(i=1){this.loading=!0,this.error=null;try{const e=this.objectTypes.find(o=>o.value===this.currentType),l={page:i,per_page:15,...this.filters};Object.keys(l).forEach(o=>{(l[o]===""||l[o]===null)&&delete l[o]});const n=await h(e.endpoint,l),s=await n.json();n.ok?(this.objects=s.data||[],this.pagination={current_page:s.current_page||1,last_page:s.last_page||1,from:s.from||0,to:s.to||0,total:s.total||0}):this.error=s.message||"Ошибка при загрузке объектов"}catch(e){console.error("Error fetching objects:",e),this.error="Ошибка при загрузке объектов"}finally{this.loading=!1}},debouncedFetchObjects(){clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{this.fetchObjects()},500)},changePage(i){this.fetchObjects(i)},viewObject(i){this.$router.push({name:"admin.parser.object.view",params:{type:this.currentType,id:i.id.toString()}}).catch(e=>{console.error("Navigation error:",e),window.location.href=`/admin/parser/objects/${this.currentType}/${i.id}/view`})},editObject(i){this.$router.push({name:"admin.parser.object.edit",params:{type:this.currentType,id:i.id.toString()}}).catch(e=>{console.error("Navigation error:",e),window.location.href=`/admin/parser/objects/${this.currentType}/${i.id}/edit`})},async deleteObject(i){if(confirm(`Вы уверены, что хотите удалить объект "${i.name}"?`))try{const e=this.objectTypes.find(n=>n.value===this.currentType),l=await v(`${e.endpoint}/${i.id}`);if(l.ok)await this.fetchObjects(this.pagination.current_page);else{const n=await l.json();alert(n.message||"Ошибка при удалении объекта")}}catch(e){console.error("Error deleting object:",e),alert("Ошибка при удалении объекта")}},getDataSourceLabel(i){return{parser:"Парсер",manual:"Вручную",feed:"Feed",import:"Импорт"}[i]||i},async checkActuality(i){if(this.checkingActuality!==i.id){this.checkingActuality=i.id;try{const e=this.objectTypes.find(s=>s.value===this.currentType);if(this.currentType!=="blocks"){alert("Проверка актуальности пока доступна только для блоков (квартир)"),this.checkingActuality=null;return}const l=await y(`/blocks/${i.id}/check-actuality`,{update:!0}),n=await l.json();if(l.ok)if(n.data&&n.data.actual)alert("✅ Данные актуальны");else if(n.data&&n.data.updated){const s=n.data.changes&&n.data.changes.length>0?n.data.changes.map(o=>o.field||o).join(", "):"Нет данных о изменениях";alert("✅ Данные обновлены. Обнаружены изменения: "+s),await this.fetchObjects(this.pagination.current_page)}else if(n.data&&n.data.changes&&n.data.changes.length>0){const s=n.data.changes.map(o=>o.field||o).join(", ");alert("⚠️ Обнаружены изменения: "+s)}else alert(n.message||"Проверка завершена");else alert(n.message||"Ошибка при проверке актуальности")}catch(e){console.error("Error checking actuality:",e),alert("Ошибка при проверке актуальности: "+(e.message||"Неизвестная ошибка"))}finally{this.checkingActuality=null}}}}},O={class:"parser-objects-page space-y-6"},T={class:"bg-card rounded-lg border border-border p-4 mb-6"},C={class:"flex flex-wrap gap-2"},A=["onClick"],D={class:"bg-card rounded-lg border border-border p-4 mb-6"},S={class:"grid grid-cols-1 md:grid-cols-4 gap-4"},E=["value"],F={key:0,class:"flex items-center justify-center py-12"},V={key:1,class:"p-4 bg-destructive/10 border border-destructive/20 rounded-lg"},P={class:"text-destructive"},N={key:2,class:"bg-card rounded-lg border border-border overflow-hidden"},U={class:"overflow-x-auto"},L={class:"w-full"},B={class:"divide-y divide-border"},I={class:"px-6 py-4 text-sm text-foreground"},M={class:"px-6 py-4 text-sm font-medium text-foreground"},q={class:"px-6 py-4 text-sm text-foreground"},z={class:"px-6 py-4 text-sm text-foreground"},G={class:"px-6 py-4 text-sm text-foreground"},R={class:"px-6 py-4 text-sm text-foreground"},H={class:"px-6 py-4 text-sm text-muted-foreground"},J={class:"px-6 py-4 text-sm text-right"},K={class:"flex items-center justify-end gap-2"},Q=["onClick","disabled"],W=["onClick"],X=["onClick"],Y=["onClick"],Z={key:3,class:"bg-card rounded-lg border border-border p-12 text-center"},$={key:4,class:"flex items-center justify-between bg-card rounded-lg border border-border p-4"},ee={class:"text-sm text-muted-foreground"},te={class:"flex gap-2"},se=["disabled"],re=["disabled"];function oe(i,e,l,n,s,o){return c(),d("div",O,[e[20]||(e[20]=t("div",{class:"flex items-center justify-between mb-6"},[t("div",null,[t("h1",{class:"text-3xl font-semibold text-foreground"},"Объекты парсера"),t("p",{class:"text-muted-foreground mt-1"},"Просмотр и управление объектами из парсера TrendAgent")])],-1)),t("div",T,[t("div",C,[(c(!0),d(b,null,f(s.objectTypes,r=>(c(),d("button",{key:r.value,onClick:p=>{s.currentType=r.value,o.fetchObjects()},class:x(["px-4 py-2 rounded-lg text-sm font-medium transition-colors",s.currentType===r.value?"bg-accent text-accent-foreground":"bg-muted text-muted-foreground hover:bg-muted/80"])},a(r.label),11,A))),128))])]),t("div",D,[t("div",S,[t("div",null,[e[10]||(e[10]=t("label",{class:"block text-sm font-medium text-foreground mb-2"},"Поиск",-1)),g(t("input",{"onUpdate:modelValue":e[0]||(e[0]=r=>s.filters.search=r),onInput:e[1]||(e[1]=(...r)=>o.debouncedFetchObjects&&o.debouncedFetchObjects(...r)),type:"text",placeholder:"Название или адрес...",class:"w-full h-10 px-3 border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-ring"},null,544),[[k,s.filters.search]])]),t("div",null,[e[12]||(e[12]=t("label",{class:"block text-sm font-medium text-foreground mb-2"},"Город",-1)),g(t("select",{"onUpdate:modelValue":e[2]||(e[2]=r=>s.filters.city_id=r),onChange:e[3]||(e[3]=(...r)=>o.fetchObjects&&o.fetchObjects(...r)),class:"w-full h-10 px-3 border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-ring"},[e[11]||(e[11]=t("option",{value:""},"Все города",-1)),(c(!0),d(b,null,f(s.cities,r=>(c(),d("option",{key:r.id,value:r.id},a(r.name),9,E))),128))],544),[[m,s.filters.city_id]])]),t("div",null,[e[14]||(e[14]=t("label",{class:"block text-sm font-medium text-foreground mb-2"},"Источник",-1)),g(t("select",{"onUpdate:modelValue":e[4]||(e[4]=r=>s.filters.data_source=r),onChange:e[5]||(e[5]=(...r)=>o.fetchObjects&&o.fetchObjects(...r)),class:"w-full h-10 px-3 border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-ring"},[...e[13]||(e[13]=[w('<option value="">Все источники</option><option value="parser">Парсер</option><option value="manual">Вручную</option><option value="feed">Feed</option><option value="import">Импорт</option>',5)])],544),[[m,s.filters.data_source]])]),t("div",null,[e[16]||(e[16]=t("label",{class:"block text-sm font-medium text-foreground mb-2"},"Статус",-1)),g(t("select",{"onUpdate:modelValue":e[6]||(e[6]=r=>s.filters.is_active=r),onChange:e[7]||(e[7]=(...r)=>o.fetchObjects&&o.fetchObjects(...r)),class:"w-full h-10 px-3 border border-border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-ring"},[...e[15]||(e[15]=[t("option",{value:""},"Все",-1),t("option",{value:"1"},"Активные",-1),t("option",{value:"0"},"Неактивные",-1)])],544),[[m,s.filters.is_active]])])])]),s.loading?(c(),d("div",F,[...e[17]||(e[17]=[t("p",{class:"text-muted-foreground"},"Загрузка объектов...",-1)])])):u("",!0),s.error?(c(),d("div",V,[t("p",P,a(s.error),1)])):u("",!0),!s.loading&&s.objects.length>0?(c(),d("div",N,[t("div",U,[t("table",L,[e[18]||(e[18]=t("thead",{class:"bg-muted/30 border-b border-border"},[t("tr",null,[t("th",{class:"px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase"},"ID"),t("th",{class:"px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase"},"Название"),t("th",{class:"px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase"},"Адрес"),t("th",{class:"px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase"},"Город"),t("th",{class:"px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase"},"Источник"),t("th",{class:"px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase"},"Статус"),t("th",{class:"px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase"},"Обновлено"),t("th",{class:"px-6 py-3 text-right text-xs font-medium text-muted-foreground uppercase"},"Действия")])],-1)),t("tbody",B,[(c(!0),d(b,null,f(s.objects,r=>(c(),d("tr",{key:r.id,class:"hover:bg-muted/10"},[t("td",I,a(r.id),1),t("td",M,a(r.name),1),t("td",q,a(r.address||"-"),1),t("td",z,a(r.city?.name||"-"),1),t("td",G,[t("span",{class:x(["px-2 py-1 text-xs rounded-md",r.data_source==="parser"?"bg-blue-500/10 text-blue-500":"bg-gray-500/10 text-gray-500"])},a(o.getDataSourceLabel(r.data_source)),3)]),t("td",R,[t("span",{class:x(["px-2 py-1 text-xs rounded-md",r.is_active?"bg-green-500/10 text-green-500":"bg-red-500/10 text-red-500"])},a(r.is_active?"Активен":"Неактивен"),3)]),t("td",H,a(r.updated_at?new Date(r.updated_at).toLocaleDateString("ru-RU"):"-"),1),t("td",J,[t("div",K,[t("button",{onClick:p=>o.checkActuality(r),disabled:s.checkingActuality===r.id,class:"px-3 py-1 text-xs bg-yellow-500 hover:bg-yellow-600 text-white rounded transition-colors disabled:opacity-50 disabled:cursor-not-allowed",title:"Проверить актуальность данных"},a(s.checkingActuality===r.id?"Проверка...":"Проверить актуальность"),9,Q),t("button",{onClick:p=>o.viewObject(r),class:"px-3 py-1 text-xs bg-blue-500 hover:bg-blue-600 text-white rounded transition-colors"}," Просмотр ",8,W),t("button",{onClick:p=>o.editObject(r),class:"px-3 py-1 text-xs bg-green-500 hover:bg-green-600 text-white rounded transition-colors"}," Редактировать ",8,X),t("button",{onClick:p=>o.deleteObject(r),class:"px-3 py-1 text-xs bg-red-500 hover:bg-red-600 text-white rounded transition-colors"}," Удалить ",8,Y)])])]))),128))])])])])):u("",!0),!s.loading&&s.objects.length===0?(c(),d("div",Z,[...e[19]||(e[19]=[t("p",{class:"text-muted-foreground"},"Объекты не найдены",-1)])])):u("",!0),!s.loading&&s.pagination&&s.pagination.last_page>1?(c(),d("div",$,[t("div",ee," Показано "+a(s.pagination.from)+" - "+a(s.pagination.to)+" из "+a(s.pagination.total),1),t("div",te,[t("button",{onClick:e[8]||(e[8]=r=>o.changePage(s.pagination.current_page-1)),disabled:s.pagination.current_page===1,class:"px-4 py-2 text-sm border border-border rounded-lg hover:bg-muted/10 disabled:opacity-50 disabled:cursor-not-allowed"}," Назад ",8,se),t("button",{onClick:e[9]||(e[9]=r=>o.changePage(s.pagination.current_page+1)),disabled:s.pagination.current_page===s.pagination.last_page,class:"px-4 py-2 text-sm border border-border rounded-lg hover:bg-muted/10 disabled:opacity-50 disabled:cursor-not-allowed"}," Вперед ",8,re)])])):u("",!0)])}const le=_(j,[["render",oe]]);export{le as default};
