name: Auto Deploy

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - '.editorconfig'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to Server
        run: |
          echo "üöÄ Starting deployment to server..."
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è secrets
          if [ -z "${{ secrets.DEPLOY_SERVER_URL }}" ]; then
            echo "‚ùå Error: DEPLOY_SERVER_URL secret is not set"
            exit 1
          fi
          
          if [ -z "${{ secrets.DEPLOY_TOKEN }}" ]; then
            echo "‚ùå Error: DEPLOY_TOKEN secret is not set"
            exit 1
          fi
          
          echo "üì° Sending deploy request to: ${{ secrets.DEPLOY_SERVER_URL }}/api/deploy"
          
          # –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          HTTP_CODE=$(curl -s -o /tmp/deploy_response.json -w "%{http_code}" \
            -X POST "${{ secrets.DEPLOY_SERVER_URL }}/api/deploy" \
            -H "Authorization: Bearer ${{ secrets.DEPLOY_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"branch": "main"}' \
            --max-time 300)
          
          echo "üì• HTTP Status Code: $HTTP_CODE"
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞
          if [ -f /tmp/deploy_response.json ]; then
            echo "üìã Server response:"
            cat /tmp/deploy_response.json | python3 -m json.tool 2>/dev/null || cat /tmp/deploy_response.json
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–¥
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "‚úÖ Deployment triggered successfully"
            exit 0
          else
            echo "‚ùå Deployment failed with HTTP status: $HTTP_CODE"
            exit 1
          fi

