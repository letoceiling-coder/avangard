# –ê–Ω–∞–ª–∏–∑ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

## ‚úÖ –ß—Ç–æ —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:

### 1. –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- **`parsed_at`** - –≤—Ä–µ–º—è –ø–µ—Ä–≤–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞
- **`last_synced_at`** - –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- **`updated_at`** - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–ª–µ Laravel

### 2. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö
- **`data_sources`** —Ç–∞–±–ª–∏—Ü–∞ - —Ö—Ä–∞–Ω–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏—Å—Ç–æ—á–Ω–∏–∫–µ –¥–∞–Ω–Ω—ã—Ö (parser, manual, feed)
- –ü–æ–ª–∏–º–æ—Ä—Ñ–Ω–∞—è —Å–≤—è–∑—å —Å –æ–±—ä–µ–∫—Ç–∞–º–∏ —á–µ—Ä–µ–∑ `DataSource` –º–æ–¥–µ–ª—å

### 3. –ë–∞–∑–æ–≤—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- `TrendDataSyncService` - —Å–µ—Ä–≤–∏—Å –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ API
- –ú–µ—Ç–æ–¥—ã `markAsSynced()` –∏ `markAsParsed()` –≤ `BaseTrendModel`

## ‚ùå –ß—Ç–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (–∫—Ä–∏—Ç–∏—á–Ω–æ):

### 1. –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –∏ –Ω–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
**–ü—Ä–æ–±–ª–µ–º–∞:** –í `TrendDataSyncService::syncBlock()` –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ `$block->update($blockData)` –±–µ–∑ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è.

**–ß—Ç–æ –Ω—É–∂–Ω–æ:**
- –°—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –∏ –Ω–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
- –û–ø—Ä–µ–¥–µ–ª—è—Ç—å, –∫–∞–∫–∏–µ –ø–æ–ª—è –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
- –û—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ –∫ –∫—Ä–∏—Ç–∏—á–Ω—ã–º –ø–æ–ª—è–º: `min_price`, `max_price`, `status`, `deadline`, `is_active`

### 2. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤–∞–∂–Ω—ã—Ö –ø–æ–ª–µ–π
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ü–µ–Ω, —Å—Ç–∞—Ç—É—Å–æ–≤ –∏ –¥—Ä—É–≥–æ–π –≤–∞–∂–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.

**–ß—Ç–æ –Ω—É–∂–Ω–æ:**
- –¢–∞–±–ª–∏—Ü–∞ `data_changes` –∏–ª–∏ `change_logs` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è –ø–æ–ª–µ–π (–∫—Ä–∏—Ç–∏—á–Ω—ã–µ: —Ü–µ–Ω—ã, —Å—Ç–∞—Ç—É—Å—ã; –æ–±—ã—á–Ω—ã–µ: –æ–ø–∏—Å–∞–Ω–∏—è, –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ)

### 3. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∏—Å—å –¥–æ–ª–≥–æ–µ –≤—Ä–µ–º—è.

**–ß—Ç–æ –Ω—É–∂–Ω–æ:**
- Scope –∏–ª–∏ –º–µ—Ç–æ–¥ –¥–ª—è –ø–æ–∏—Å–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤, —É –∫–æ—Ç–æ—Ä—ã—Ö `last_synced_at` —Å—Ç–∞—Ä—à–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
- API endpoint –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –æ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö

### 4. –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ü–µ–Ω
**–ü—Ä–æ–±–ª–µ–º–∞:** `BlockPrice` —Ö—Ä–∞–Ω–∏—Ç —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∏–µ —Ü–µ–Ω—ã, –Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏.

**–ß—Ç–æ –Ω—É–∂–Ω–æ:**
- –¢–∞–±–ª–∏—Ü–∞ `price_history` –∏–ª–∏ `block_price_history`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Ü–µ–Ω –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
- API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω

### 5. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤–∞–∂–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

**–ß—Ç–æ –Ω—É–∂–Ω–æ:**
- –°–æ–±—ã—Ç–∏—è (Events) –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ü–µ–Ω, —Å—Ç–∞—Ç—É—Å–æ–≤
- –û—á–µ—Ä–µ–¥–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- Email/Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º

## üîß –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

### 1. –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `data_changes` –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:

```php
Schema::create('data_changes', function (Blueprint $table) {
    $table->id();
    $table->morphs('changeable'); // changeable_type, changeable_id
    $table->string('field_name'); // –ù–∞–∑–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—è
    $table->text('old_value')->nullable(); // –°—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (JSON)
    $table->text('new_value')->nullable(); // –ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (JSON)
    $table->enum('change_type', ['price', 'status', 'important', 'other']);
    $table->string('source')->default('parser'); // parser, manual, feed
    $table->foreignId('user_id')->nullable()->constrained()->onDelete('set null');
    $table->timestamp('changed_at');
    $table->timestamps();
    
    $table->index(['changeable_type', 'changeable_id', 'changed_at']);
    $table->index(['change_type', 'changed_at']);
});
```

### 2. –£–ª—É—á—à–∏—Ç—å `TrendDataSyncService`:

```php
public function syncBlock(array $apiData, array $options = []): Block
{
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
    
    if ($block && $options['update_existing']) {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        $oldValues = $block->getOriginal();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º
        $block->update($blockData);
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
        $changes = $this->detectChanges($oldValues, $blockData, [
            'critical_fields' => ['min_price', 'max_price', 'status', 'is_active', 'deadline_date'],
            'important_fields' => ['name', 'address', 'finishing'],
        ]);
        
        // –õ–æ–≥–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
        if (!empty($changes)) {
            $this->logChanges($block, $changes, 'parser');
        }
    }
    
    // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ ...
}

protected function detectChanges(array $oldValues, array $newValues, array $fieldPriorities): array
{
    $changes = [];
    
    foreach ($newValues as $field => $newValue) {
        $oldValue = $oldValues[$field] ?? null;
        
        if ($oldValue !== $newValue) {
            $changeType = $this->getChangeType($field, $fieldPriorities);
            $changes[] = [
                'field' => $field,
                'old_value' => $oldValue,
                'new_value' => $newValue,
                'type' => $changeType,
            ];
        }
    }
    
    return $changes;
}

protected function logChanges(Model $model, array $changes, string $source): void
{
    foreach ($changes as $change) {
        DataChange::create([
            'changeable_type' => get_class($model),
            'changeable_id' => $model->id,
            'field_name' => $change['field'],
            'old_value' => json_encode($change['old_value']),
            'new_value' => json_encode($change['new_value']),
            'change_type' => $change['type'],
            'source' => $source,
            'changed_at' => now(),
        ]);
    }
}
```

### 3. –î–æ–±–∞–≤–∏—Ç—å scope –¥–ª—è —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö:

```php
// –í BaseTrendModel
public function scopeOutdated($query, int $days = 7)
{
    return $query->where('last_synced_at', '<', now()->subDays($days))
                 ->orWhereNull('last_synced_at');
}

// API endpoint
public function outdatedBlocks(Request $request)
{
    $days = $request->get('days', 7);
    $blocks = Block::outdated($days)->get();
    
    return BlockResource::collection($blocks);
}
```

### 4. –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –∏—Å—Ç–æ—Ä–∏–∏ —Ü–µ–Ω:

```php
Schema::create('price_history', function (Blueprint $table) {
    $table->id();
    $table->morphs('priceable'); // priceable_type, priceable_id (Block, Parking, etc.)
    $table->enum('price_type', ['min', 'max', 'fixed']); // –¢–∏–ø —Ü–µ–Ω—ã
    $table->unsignedBigInteger('old_price')->nullable(); // –°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞ –≤ –∫–æ–ø–µ–π–∫–∞—Ö
    $table->unsignedBigInteger('new_price')->nullable(); // –ù–æ–≤–∞—è —Ü–µ–Ω–∞ –≤ –∫–æ–ø–µ–π–∫–∞—Ö
    $table->decimal('change_percent', 5, 2)->nullable(); // –ü—Ä–æ—Ü–µ–Ω—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è
    $table->string('source')->default('parser');
    $table->timestamp('changed_at');
    $table->timestamps();
    
    $table->index(['priceable_type', 'priceable_id', 'changed_at']);
});
```

## üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

### –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–∫—Ä–∏—Ç–∏—á–Ω–æ):
1. ‚úÖ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –∏ –Ω–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
2. ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –ø–æ–ª–µ–π (—Ü–µ–Ω—ã, —Å—Ç–∞—Ç—É—Å—ã)
3. ‚úÖ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö

### –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
4. ‚ö†Ô∏è –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ü–µ–Ω
5. ‚ö†Ô∏è API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
6. ‚ö†Ô∏è –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö

### –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
7. üìã Dashboard —Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –∏–∑–º–µ–Ω–µ–Ω–∏–π
8. üìã –≠–∫—Å–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
9. üìã –ì—Ä–∞—Ñ–∏–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω

## üìä –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:

| –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª | –°—Ç–∞—Ç—É—Å | –ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å |
|------------|--------|-------------|
| –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ | –ù–∏–∑–∫–∞—è |
| –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ | –°—Ä–µ–¥–Ω—è—è |
| –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö/–Ω–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π | ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç | **–í—ã—Å–æ–∫–∞—è** |
| –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π | ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç | **–í—ã—Å–æ–∫–∞—è** |
| –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö | ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç | **–í—ã—Å–æ–∫–∞—è** |
| –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ü–µ–Ω | ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç | –°—Ä–µ–¥–Ω—è—è |
| –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö | ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç | –ù–∏–∑–∫–∞—è |

