# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤

## –û–±–∑–æ—Ä

–°–æ–∑–¥–∞–Ω—ã —Å–µ—Ä–≤–∏—Å `TrendDirectoriesService` –∏ –∫–æ–º–∞–Ω–¥–∞ `SyncTrendDirectories` –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ (—Ä–µ–≥–∏–æ–Ω—ã, –ª–æ–∫–∞—Ü–∏–∏, –º–µ—Ç—Ä–æ) –∏–∑ TrendAgent API.

## –°–µ—Ä–≤–∏—Å: TrendDirectoriesService

### –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã

#### `fetchDirectories(City $city, array $types = []): array`
–ü–æ–ª—É—á–∞–µ—Ç —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ –∏–∑ API –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞.

```php
use App\Services\TrendDirectoriesService;
use App\Models\Trend\City;

$service = new TrendDirectoriesService();
$service->setAuthToken($authToken);

$city = City::where('guid', 'msk')->first();
$directories = $service->fetchDirectories($city, ['regions', 'locations', 'subways']);
```

#### `syncRegions(City $city, array $regionsData): array`
–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç —Ä–µ–≥–∏–æ–Ω—ã –¥–ª—è –≥–æ—Ä–æ–¥–∞.

#### `syncLocations(City $city, array $locationsData): array`
–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –ª–æ–∫–∞—Ü–∏–∏ –¥–ª—è –≥–æ—Ä–æ–¥–∞.

#### `syncSubways(City $city, array $subwaysData): array`
–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –º–µ—Ç—Ä–æ –¥–ª—è –≥–æ—Ä–æ–¥–∞ (–≤–∫–ª—é—á–∞—è –ª–∏–Ω–∏–∏ –º–µ—Ç—Ä–æ).

#### `syncAll(City $city): array`
–ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ –¥–ª—è –≥–æ—Ä–æ–¥–∞.

```php
$result = $service->syncAll($city);
// –†–µ–∑—É–ª—å—Ç–∞—Ç:
// [
//     'success' => true,
//     'city' => '–ú–æ—Å–∫–≤–∞',
//     'guid' => 'msk',
//     'stats' => [
//         'regions' => ['created' => 10, 'updated' => 5, 'skipped' => 0, 'errors' => 0],
//         'locations' => [...],
//         'subways' => [...],
//     ],
//     'errors' => [],
// ]
```

## –ö–æ–º–∞–Ω–¥–∞: trend:sync-directories

### –ë–∞–∑–æ–≤–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```bash
# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–ª—è –æ–¥–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞
php artisan trend:sync-directories --city=msk --phone="+7 999 637 11 82" --password="password"

# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –≥–æ—Ä–æ–¥–æ–≤ —Å external_id
php artisan trend:sync-directories --all --phone="+7 999 637 11 82" --password="password"
```

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã

- `--city=GUID` - GUID –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: `msk`, `spb`)
- `--all` - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –≥–æ—Ä–æ–¥–∞ —Å `external_id`
- `--phone=PHONE` - –¢–µ–ª–µ—Ñ–æ–Ω –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤ config)
- `--password=PASSWORD` - –ü–∞—Ä–æ–ª—å –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤ config)

### –ü—Ä–∏–º–µ—Ä—ã

```bash
# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ú–æ—Å–∫–≤—ã
php artisan trend:sync-directories --city=msk

# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥–∞
php artisan trend:sync-directories --city=spb

# –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –≥–æ—Ä–æ–¥–æ–≤
php artisan trend:sync-directories --all
```

### –í—ã–≤–æ–¥ –∫–æ–º–∞–Ω–¥—ã

```
üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ TrendAgent...

üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Trend SSO...
‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!

‚úÖ –ù–∞–π–¥–µ–Ω–æ –≥–æ—Ä–æ–¥–æ–≤: 7

 7/7 [‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì] 100%

üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

+----------+---------+-----------+-----------+--------+
| –¢–∏–ø      | –°–æ–∑–¥–∞–Ω–æ | –û–±–Ω–æ–≤–ª–µ–Ω–æ | –ü—Ä–æ–ø—É—â–µ–Ω–æ | –û—à–∏–±–æ–∫ |
+----------+---------+-----------+-----------+--------+
| –†–µ–≥–∏–æ–Ω—ã  | 45      | 12        | 0         | 0      |
| –õ–æ–∫–∞—Ü–∏–∏  | 120     | 35        | 2         | 0      |
| –ú–µ—Ç—Ä–æ    | 78      | 5         | 0         | 0      |
+----------+---------+-----------+-----------+--------+

‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –≥–æ—Ä–æ–¥–æ–≤: 7
```

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

1. **External_ID –≥–æ—Ä–æ–¥–∞**: –ì–æ—Ä–æ–¥ –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–π `external_id` (MongoDB ObjectId)
2. **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è**: –¢—Ä–µ–±—É–µ—Ç—Å—è —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ TrendAgent API

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö

### –†–µ–≥–∏–æ–Ω—ã
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –ø–æ `external_id` –∏–ª–∏ `guid + city_id`
- –û–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø–æ–ª—è: `name`, `crm_id`, `external_id`, `sort_order` (–∏–∑ `priority`)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è `is_active = true`

### –õ–æ–∫–∞—Ü–∏–∏
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –ø–æ `external_id` –∏–ª–∏ `guid + city_id`
- –û–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø–æ–ª—è: `name`, `crm_id`, `external_id`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è `is_active = true`

### –ú–µ—Ç—Ä–æ
- –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞—é—Ç—Å—è/–æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ª–∏–Ω–∏–∏ –º–µ—Ç—Ä–æ (`SubwayLine`)
- –ó–∞—Ç–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è —Å—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ (`Subway`)
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –ø–æ `external_id` –∏–ª–∏ `guid + city_id`
- –û–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø–æ–ª—è: `name`, `crm_id`, `external_id`, `priority`, `subway_line_id`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è `is_active = true`

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è:
- –£—Å–ø–µ—à–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: `Log::info`
- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (–ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏): `Log::warning`
- –û—à–∏–±–∫–∏: `Log::error`

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

- –ï—Å–ª–∏ —É –≥–æ—Ä–æ–¥–∞ –Ω–µ—Ç `external_id` - –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
- –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω - –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
- –ï—Å–ª–∏ API –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É - –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –∏ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
- –û—Ç–¥–µ–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏ —Å –æ—à–∏–±–∫–∞–º–∏ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è, –Ω–æ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—é—Ç –æ–±—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

–ú–æ–∂–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤:
1. **–ü–∞—Ä—Å–µ—Ä –¥–∞–Ω–Ω—ã—Ö** - –æ–±–Ω–æ–≤–ª—è—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ –ø–µ—Ä–µ–¥ –ø–∞—Ä—Å–∏–Ω–≥–æ–º
2. **–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á** - –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ä–∞–∑ –≤ –¥–µ–Ω—å)
3. **–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å** - —Ä—É—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É

