# –ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–∞—Ä—Å–µ—Ä–∞ TrendAgent

–ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ë–î —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏, –º–æ–¥–µ–ª—è–º–∏, —Ñ–∏–ª—å—Ç—Ä–∞–º–∏, —Ä–µ—Å—É—Ä—Å–∞–º–∏ –∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏.

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-12-28  
**–¶–µ–ª—å:** –ì–∏–±–∫–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–î –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ø–∞—Ä—Å–µ—Ä–∞, –∞–¥–º–∏–Ω–∫–∏ –∏ —Ñ–∞–π–ª–æ–≤/feed

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ë–î](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-–±–¥)
2. [–ú–∏–≥—Ä–∞—Ü–∏–∏](#–º–∏–≥—Ä–∞—Ü–∏–∏)
3. [–ú–æ–¥–µ–ª–∏](#–º–æ–¥–µ–ª–∏)
4. [–§–∏–ª—å—Ç—Ä—ã](#—Ñ–∏–ª—å—Ç—Ä—ã)
5. [–†–µ—Å—É—Ä—Å—ã](#—Ä–µ—Å—É—Ä—Å—ã)
6. [–ó–∞–ø—Ä–æ—Å—ã](#–∑–∞–ø—Ä–æ—Å—ã)
7. [–û—Ç–Ω–æ—à–µ–Ω–∏—è](#–æ—Ç–Ω–æ—à–µ–Ω–∏—è)

---

## üóÑÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ë–î

### –î–∏–∞–≥—Ä–∞–º–º–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   cities    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îú‚îÄ‚îÄ‚îÄ‚îê
       ‚îÇ   ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   regions       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îú‚îÄ‚îÄ‚îÄ‚îê
       ‚îÇ   ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   locations     ‚îÇ     ‚îÇ   builders   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                       ‚îÇ
       ‚îÇ              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
       ‚îÇ              ‚îÇ                 ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              blocks (apartments)                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚îú‚îÄ‚îÄ‚îÄ‚îê
       ‚îÇ   ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  block_subways      ‚îÇ (pivot)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   subways   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –¢–∏–ø—ã –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö

```php
enum DataSource: string
{
    case PARSER = 'parser';      // –ò–∑ –ø–∞—Ä—Å–µ—Ä–∞ TrendAgent API
    case MANUAL = 'manual';      // –°–æ–∑–¥–∞–Ω–æ –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É
    case FEED = 'feed';          // –ó–∞–≥—Ä—É–∂–µ–Ω–æ —á–µ—Ä–µ–∑ —Ñ–∞–π–ª/feed
    case IMPORT = 'import';      // –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –∏–∑ –¥—Ä—É–≥–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
}
```

---

## üìä –ú–∏–≥—Ä–∞—Ü–∏–∏

### 1. –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ (Directories)

#### cities (–ì–æ—Ä–æ–¥–∞)

```php
Schema::create('cities', function (Blueprint $table) {
    $table->id();
    $table->string('guid')->unique();           // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π slug –∏–∑ API
    $table->string('name');                     // –ù–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞
    $table->unsignedBigInteger('crm_id')->nullable()->unique(); // ID –≤ CRM
    $table->string('external_id')->nullable()->index(); // ID –∏–∑ –≤–Ω–µ—à–Ω–µ–π —Å–∏—Å—Ç–µ–º—ã (MongoDB _id)
    $table->boolean('is_active')->default(true);
    $table->integer('sort_order')->default(0);
    $table->timestamps();
    $table->softDeletes();
    
    $table->index(['guid', 'is_active']);
});
```

#### regions (–†–∞–π–æ–Ω—ã)

```php
Schema::create('regions', function (Blueprint $table) {
    $table->id();
    $table->foreignId('city_id')->constrained()->onDelete('cascade');
    $table->string('guid')->unique();
    $table->string('name');
    $table->unsignedBigInteger('crm_id')->nullable();
    $table->string('external_id')->nullable()->index();
    $table->boolean('is_active')->default(true);
    $table->integer('sort_order')->default(0);
    $table->timestamps();
    $table->softDeletes();
    
    $table->index(['city_id', 'is_active']);
    $table->index(['guid', 'city_id']);
});
```

#### locations (–õ–æ–∫–∞—Ü–∏–∏/–û–∫—Ä—É–≥–∞)

```php
Schema::create('locations', function (Blueprint $table) {
    $table->id();
    $table->foreignId('city_id')->constrained()->onDelete('cascade');
    $table->string('guid')->unique();
    $table->string('name');
    $table->unsignedBigInteger('crm_id')->nullable();
    $table->string('external_id')->nullable()->index();
    $table->boolean('is_active')->default(true);
    $table->integer('sort_order')->default(0);
    $table->timestamps();
    $table->softDeletes();
    
    $table->index(['city_id', 'is_active']);
});
```

#### builders (–ó–∞—Å—Ç—Ä–æ–π—â–∏–∫–∏)

```php
Schema::create('builders', function (Blueprint $table) {
    $table->id();
    $table->string('guid')->unique();
    $table->string('name');
    $table->unsignedBigInteger('crm_id')->nullable();
    $table->string('external_id')->nullable()->index();
    $table->text('description')->nullable();
    $table->string('website')->nullable();
    $table->string('email')->nullable();
    $table->string('phone')->nullable();
    $table->boolean('is_active')->default(true);
    $table->boolean('is_exclusive')->default(false);
    $table->integer('sort_order')->default(0);
    $table->timestamps();
    $table->softDeletes();
    
    $table->index(['guid', 'is_active']);
    $table->index('is_exclusive');
});
```

#### subway_lines (–õ–∏–Ω–∏–∏ –º–µ—Ç—Ä–æ)

```php
Schema::create('subway_lines', function (Blueprint $table) {
    $table->id();
    $table->foreignId('city_id')->constrained()->onDelete('cascade');
    $table->string('name');
    $table->string('color', 7)->nullable();     // Hex —Ü–≤–µ—Ç (#2489c2)
    $table->integer('line_number')->nullable();
    $table->string('external_id')->nullable()->index();
    $table->boolean('is_active')->default(true);
    $table->integer('sort_order')->default(0);
    $table->timestamps();
    $table->softDeletes();
    
    $table->index(['city_id', 'line_number']);
});
```

#### subways (–°—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ)

```php
Schema::create('subways', function (Blueprint $table) {
    $table->id();
    $table->foreignId('subway_line_id')->constrained()->onDelete('cascade');
    $table->foreignId('city_id')->constrained()->onDelete('cascade');
    $table->string('guid')->unique();
    $table->string('name');
    $table->unsignedBigInteger('crm_id')->nullable();
    $table->string('external_id')->nullable()->index();
    $table->decimal('latitude', 10, 8)->nullable();
    $table->decimal('longitude', 11, 8)->nullable();
    $table->integer('priority')->default(500);  // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    $table->boolean('is_active')->default(true);
    $table->integer('sort_order')->default(0);
    $table->timestamps();
    $table->softDeletes();
    
    $table->index(['subway_line_id', 'city_id']);
    $table->index(['latitude', 'longitude']);
    $table->index(['guid', 'city_id']);
});
```

---

### 2. –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –æ–±—ä–µ–∫—Ç–æ–≤

#### blocks (–ñ–ö / –ë–ª–æ–∫–∏ –∫–≤–∞—Ä—Ç–∏—Ä)

```php
Schema::create('blocks', function (Blueprint $table) {
    $table->id();
    
    // –°–≤—è–∑–∏ —Å–æ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞–º–∏
    $table->foreignId('city_id')->constrained()->onDelete('restrict');
    $table->foreignId('region_id')->nullable()->constrained()->onDelete('set null');
    $table->foreignId('location_id')->nullable()->constrained()->onDelete('set null');
    $table->foreignId('builder_id')->nullable()->constrained()->onDelete('set null');
    
    // –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    $table->string('guid')->unique();
    $table->string('name');
    $table->text('address')->nullable();        // JSON –∏–ª–∏ —Ç–µ–∫—Å—Ç
    $table->unsignedBigInteger('crm_id')->nullable();
    $table->string('external_id')->nullable()->index(); // MongoDB _id
    
    // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
    $table->decimal('latitude', 10, 8)->nullable();
    $table->decimal('longitude', 11, 8)->nullable();
    
    // –°—Ç–∞—Ç—É—Å—ã –∏ —Ñ–ª–∞–≥–∏
    $table->integer('status')->default(1);      // 1 = –∞–∫—Ç–∏–≤–µ–Ω
    $table->integer('edit_mode')->nullable();
    $table->boolean('is_suite')->default(false);
    $table->boolean('is_exclusive')->default(false);
    $table->boolean('is_marked')->default(false);
    $table->boolean('is_active')->default(true);
    
    // –¶–µ–Ω—ã
    $table->unsignedBigInteger('min_price')->nullable();  // –í –∫–æ–ø–µ–π–∫–∞—Ö
    $table->unsignedBigInteger('max_price')->nullable();
    
    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    $table->unsignedInteger('apartments_count')->default(0);
    $table->unsignedInteger('view_apartments_count')->default(0);
    $table->unsignedInteger('exclusive_apartments_count')->default(0);
    
    // –°—Ä–æ–∫–∏ –∏ –æ—Ç–¥–µ–ª–∫–∞
    $table->string('deadline')->nullable();     // –¢–µ–∫—Å—Ç —Å—Ä–æ–∫–∞ —Å–¥–∞—á–∏
    $table->timestamp('deadline_date')->nullable(); // –î–∞—Ç–∞ —Å–¥–∞—á–∏
    $table->boolean('deadline_over_check')->default(false);
    $table->string('finishing')->nullable();    // –¢–∏–ø –æ—Ç–¥–µ–ª–∫–∏
    
    // –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö
    $table->enum('data_source', ['parser', 'manual', 'feed', 'import'])->default('manual');
    $table->timestamp('parsed_at')->nullable(); // –ö–æ–≥–¥–∞ –±—ã–ª —Å–ø–∞—Ä—Å–µ–Ω
    $table->timestamp('last_synced_at')->nullable(); // –ü–æ—Å–ª–µ–¥–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
    
    // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    $table->json('metadata')->nullable();       // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    $table->json('advantages')->nullable();     // –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ (–º–∞—Å—Å–∏–≤)
    $table->json('payment_types')->nullable();  // –¢–∏–ø—ã –æ–ø–ª–∞—Ç—ã
    $table->json('contract_types')->nullable(); // –¢–∏–ø—ã –¥–æ–≥–æ–≤–æ—Ä–æ–≤
    $table->json('installments')->nullable();   // –†–∞—Å—Å—Ä–æ—á–∫–∞
    
    $table->timestamps();
    $table->softDeletes();
    
    // –ò–Ω–¥–µ–∫—Å—ã
    $table->index(['city_id', 'is_active', 'status']);
    $table->index(['builder_id', 'is_active']);
    $table->index(['guid', 'city_id']);
    $table->index(['data_source', 'parsed_at']);
    $table->index(['latitude', 'longitude']);
    $table->index('is_exclusive');
    $table->fullText(['name', 'address']);      // –ü–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫
});
```

#### block_subways (–°–≤—è–∑—å –±–ª–æ–∫–æ–≤ –∏ —Å—Ç–∞–Ω—Ü–∏–π –º–µ—Ç—Ä–æ)

```php
Schema::create('block_subways', function (Blueprint $table) {
    $table->id();
    $table->foreignId('block_id')->constrained()->onDelete('cascade');
    $table->foreignId('subway_id')->constrained()->onDelete('cascade');
    $table->integer('distance_time')->nullable();      // –í—Ä–µ–º—è –≤ –º–∏–Ω—É—Ç–∞—Ö
    $table->integer('distance_type_id')->nullable();   // 1 = –ø–µ—à–∫–æ–º, 2 = —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–º
    $table->string('distance_type')->nullable();       // "–ø–µ—à–∫–æ–º", "—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–º"
    $table->integer('priority')->default(500);
    $table->timestamps();
    
    $table->unique(['block_id', 'subway_id']);
    $table->index(['block_id', 'priority']);
});
```

#### block_prices (–¶–µ–Ω—ã –ø–æ —Ç–∏–ø–∞–º –∫–≤–∞—Ä—Ç–∏—Ä)

```php
Schema::create('block_prices', function (Blueprint $table) {
    $table->id();
    $table->foreignId('block_id')->constrained()->onDelete('cascade');
    $table->integer('room_type_id')->nullable();       // –ö–æ–¥ —Ç–∏–ø–∞ (60 = —Å–≤–æ–±–æ–¥–Ω–∞—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞)
    $table->string('room_type_name')->nullable();      // –ù–∞–∑–≤–∞–Ω–∏–µ ("–°—Ç—É–¥–∏—è", "1-–∫")
    $table->unsignedBigInteger('price')->nullable();   // –í –∫–æ–ø–µ–π–∫–∞—Ö
    $table->integer('sort_order')->default(0);
    $table->timestamps();
    
    $table->index(['block_id', 'room_type_id']);
});
```

#### parkings (–ü–∞—Ä–∫–∏–Ω–≥)

```php
Schema::create('parkings', function (Blueprint $table) {
    $table->id();
    
    // –°–≤—è–∑–∏
    $table->foreignId('block_id')->nullable()->constrained()->onDelete('set null');
    $table->foreignId('city_id')->constrained()->onDelete('restrict');
    $table->foreignId('district_id')->nullable()->constrained('regions')->onDelete('set null');
    $table->foreignId('location_id')->nullable()->constrained()->onDelete('set null');
    $table->foreignId('builder_id')->nullable()->constrained()->onDelete('set null');
    
    // –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    $table->string('external_id')->nullable()->index();
    $table->string('block_guid')->nullable();          // GUID –±–ª–æ–∫–∞ –∏–∑ API
    $table->string('block_name')->nullable();
    $table->string('number')->nullable();              // –ù–æ–º–µ—Ä –º–µ—Å—Ç–∞
    $table->integer('floor')->nullable();              // –≠—Ç–∞–∂ (–º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º)
    $table->decimal('area', 8, 2)->nullable();         // –ü–ª–æ—â–∞–¥—å –≤ –º¬≤
    
    // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
    $table->decimal('latitude', 10, 8)->nullable();
    $table->decimal('longitude', 11, 8)->nullable();
    
    // –¢–∏–ø—ã –∏ —Å—Ç–∞—Ç—É—Å—ã
    $table->string('parking_type')->nullable();        // "–ü–æ–¥–∑–µ–º–Ω—ã–π", "–ù–∞–∑–µ–º–Ω—ã–π"
    $table->string('place_type')->nullable();          // "–£–≤–µ–ª–∏—á–µ–Ω–Ω–æ–µ", "–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ"
    $table->string('property_type')->nullable();       // "new", "secondary"
    $table->string('status')->default('available');    // "available", "booked"
    $table->string('status_label')->nullable();        // "–°–≤–æ–±–æ–¥–Ω–æe"
    
    // –¶–µ–Ω–∞ –∏ –∫–æ–º–∏—Å—Å–∏—è
    $table->unsignedBigInteger('price')->nullable();
    $table->string('reward_label')->nullable();        // "0.6-0.8%"
    
    // –°—Ä–æ–∫–∏
    $table->string('deadline')->nullable();
    $table->timestamp('deadline_date')->nullable();
    $table->boolean('deadline_over_check')->default(false);
    
    // –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö
    $table->enum('data_source', ['parser', 'manual', 'feed', 'import'])->default('manual');
    $table->timestamp('parsed_at')->nullable();
    $table->timestamp('last_synced_at')->nullable();
    
    // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    $table->json('metadata')->nullable();
    
    $table->timestamps();
    $table->softDeletes();
    
    $table->index(['block_id', 'status']);
    $table->index(['city_id', 'status']);
    $table->index(['data_source', 'parsed_at']);
    $table->index(['latitude', 'longitude']);
});
```

#### parking_subways (–°–≤—è–∑—å –ø–∞—Ä–∫–∏–Ω–≥–∞ –∏ –º–µ—Ç—Ä–æ)

```php
Schema::create('parking_subways', function (Blueprint $table) {
    $table->id();
    $table->foreignId('parking_id')->constrained()->onDelete('cascade');
    $table->foreignId('subway_id')->constrained()->onDelete('cascade');
    $table->integer('distance_time')->nullable();
    $table->integer('distance_type_id')->nullable();
    $table->integer('priority')->default(500);
    $table->timestamps();
    
    $table->unique(['parking_id', 'subway_id']);
});
```

#### villages (–ü–æ—Å–µ–ª–∫–∏ / –î–æ–º–∞ —Å —É—á–∞—Å—Ç–∫–∞–º–∏)

```php
Schema::create('villages', function (Blueprint $table) {
    $table->id();
    
    // –°–≤—è–∑–∏
    $table->foreignId('city_id')->constrained()->onDelete('restrict');
    $table->foreignId('builder_id')->nullable()->constrained()->onDelete('set null');
    
    // –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    $table->string('guid')->unique();
    $table->string('name');
    $table->text('address')->nullable();
    $table->string('external_id')->nullable()->index();
    
    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    $table->unsignedInteger('plots_count')->default(0);
    $table->unsignedInteger('view_plots_count')->default(0);
    
    // –†–∞—Å—Å—Ç–æ—è–Ω–∏—è
    $table->json('distance')->nullable();       // –î–æ —Ü–µ–Ω—Ç—Ä–∞, –∂/–¥, —Ç—Ä–∞—Å—Å—ã
    
    // –°—Ä–æ–∫–∏ –∏ —Å—Ç–∞—Ä—Ç –ø—Ä–æ–¥–∞–∂
    $table->string('deadline')->nullable();
    $table->timestamp('deadline_date')->nullable();
    $table->string('sales_start')->nullable();
    $table->timestamp('sales_start_date')->nullable();
    
    // –ö–æ–º–∏—Å—Å–∏—è
    $table->string('reward_label')->nullable();
    
    // –§–ª–∞–≥–∏
    $table->boolean('is_new_village')->default(false);
    $table->boolean('is_active')->default(true);
    
    // –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö
    $table->enum('data_source', ['parser', 'manual', 'feed', 'import'])->default('manual');
    $table->timestamp('parsed_at')->nullable();
    $table->timestamp('last_synced_at')->nullable();
    
    // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    $table->json('metadata')->nullable();
    $table->json('property_types')->nullable();
    
    $table->timestamps();
    $table->softDeletes();
    
    $table->index(['city_id', 'is_active']);
    $table->index(['builder_id', 'is_active']);
    $table->index(['data_source', 'parsed_at']);
    $table->fullText(['name', 'address']);
});
```

#### village_prices (–¶–µ–Ω—ã –ø–æ—Å–µ–ª–∫–æ–≤ –ø–æ —Ç–∏–ø–∞–º —É—á–∞—Å—Ç–∫–æ–≤)

```php
Schema::create('village_prices', function (Blueprint $table) {
    $table->id();
    $table->foreignId('village_id')->constrained()->onDelete('cascade');
    $table->string('label')->nullable();               // "–£—á–∞—Å—Ç–∫–∏ 5-10 —Å–æ—Ç."
    $table->unsignedBigInteger('price')->nullable();   // –í –∫–æ–ø–µ–π–∫–∞—Ö
    $table->unsignedBigInteger('unformatted_price')->nullable();
    $table->string('unit')->default('‚ÇΩ');
    $table->integer('sort_order')->default(0);
    $table->timestamps();
    
    $table->index(['village_id', 'sort_order']);
});
```

#### commercial_blocks (–ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–µ –±–ª–æ–∫–∏)

```php
Schema::create('commercial_blocks', function (Blueprint $table) {
    $table->id();
    
    // –°–≤—è–∑–∏
    $table->foreignId('city_id')->constrained()->onDelete('restrict');
    $table->foreignId('builder_id')->nullable()->constrained()->onDelete('set null');
    $table->foreignId('district_id')->nullable()->constrained('regions')->onDelete('set null');
    $table->foreignId('location_id')->nullable()->constrained()->onDelete('set null');
    
    // –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    $table->string('guid')->unique();
    $table->string('name');
    $table->text('address')->nullable();
    $table->string('external_id')->nullable()->index();
    
    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    $table->unsignedInteger('premises_count')->default(0);
    $table->unsignedInteger('booked_premises_count')->default(0);
    
    // –§–ª–∞–≥–∏
    $table->boolean('is_new_block')->default(false);
    $table->boolean('is_active')->default(true);
    
    // –°—Ä–æ–∫–∏
    $table->json('deadlines')->nullable();             // –ú–∞—Å—Å–∏–≤ —Å—Ä–æ–∫–æ–≤
    $table->timestamp('deadline_date')->nullable();
    $table->boolean('deadline_over_check')->default(false);
    $table->json('sales_start_at')->nullable();       // –ú–∞—Å—Å–∏–≤ –¥–∞—Ç —Å—Ç–∞—Ä—Ç–∞ –ø—Ä–æ–¥–∞–∂
    
    // –ö–æ–º–∏—Å—Å–∏—è
    $table->string('reward_label')->nullable();
    
    // –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö
    $table->enum('data_source', ['parser', 'manual', 'feed', 'import'])->default('manual');
    $table->timestamp('parsed_at')->nullable();
    $table->timestamp('last_synced_at')->nullable();
    
    // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    $table->json('metadata')->nullable();
    $table->json('property_types')->nullable();
    $table->json('min_prices')->nullable();           // –¶–µ–Ω—ã –ø–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è–º
    
    $table->timestamps();
    $table->softDeletes();
    
    $table->index(['city_id', 'is_active']);
    $table->index(['builder_id', 'is_active']);
    $table->index(['data_source', 'parsed_at']);
    $table->fullText(['name', 'address']);
});
```

#### commercial_block_subways (–°–≤—è–∑—å –∫–æ–º–º–µ—Ä—Ü–∏–∏ –∏ –º–µ—Ç—Ä–æ)

```php
Schema::create('commercial_block_subways', function (Blueprint $table) {
    $table->id();
    $table->foreignId('commercial_block_id')->constrained()->onDelete('cascade');
    $table->foreignId('subway_id')->constrained()->onDelete('cascade');
    $table->integer('distance_time')->nullable();
    $table->integer('distance_type_id')->nullable();
    $table->integer('priority')->default(500);
    $table->timestamps();
    
    $table->unique(['commercial_block_id', 'subway_id']);
});
```

---

### 3. –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (Polymorphic)

#### images (–ü–æ–ª–∏–º–æ—Ä—Ñ–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π)

```php
Schema::create('images', function (Blueprint $table) {
    $table->id();
    
    // –ü–æ–ª–∏–º–æ—Ä—Ñ–Ω–∞—è —Å–≤—è–∑—å
    $table->morphs('imageable');                      // imageable_type, imageable_id
    
    // –î–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    $table->string('external_id')->nullable()->index(); // MongoDB _id
    $table->string('path')->nullable();               // –ü—É—Ç—å –Ω–∞ CDN
    $table->string('file_name');                     // –ò–º—è —Ñ–∞–π–ª–∞
    $table->string('url_thumbnail')->nullable();     // URL –º–∏–Ω–∏–∞—Ç—é—Ä—ã
    $table->string('url_full')->nullable();          // URL –ø–æ–ª–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    $table->string('alt')->nullable();
    $table->string('title')->nullable();
    $table->text('description')->nullable();
    
    // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    $table->integer('width')->nullable();
    $table->integer('height')->nullable();
    $table->unsignedBigInteger('size')->nullable();  // –†–∞–∑–º–µ—Ä –≤ –±–∞–π—Ç–∞—Ö
    $table->string('mime_type')->nullable();
    
    // –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (–µ—Å–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–æ)
    $table->string('local_path')->nullable();
    $table->string('disk')->default('public');
    
    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
    $table->integer('sort_order')->default(0);
    $table->boolean('is_main')->default(false);      // –ì–ª–∞–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    
    $table->timestamps();
    $table->softDeletes();
    
    $table->index(['imageable_type', 'imageable_id', 'sort_order']);
    $table->index(['is_main', 'imageable_type']);
});
```

---

### 4. –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

#### data_sources (–õ–æ–≥–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö)

```php
Schema::create('data_sources', function (Blueprint $table) {
    $table->id();
    $table->enum('source_type', ['parser', 'manual', 'feed', 'import']);
    $table->string('source_name')->nullable();       // –ù–∞–∑–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
    $table->string('source_file')->nullable();       // –ò–º—è —Ñ–∞–π–ª–∞ (–¥–ª—è feed)
    $table->morphs('sourceable');                    // –ß—Ç–æ –±—ã–ª–æ —Å–æ–∑–¥–∞–Ω–æ/–æ–±–Ω–æ–≤–ª–µ–Ω–æ
    $table->foreignId('user_id')->nullable()->constrained()->onDelete('set null');
    $table->json('metadata')->nullable();            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    $table->timestamp('processed_at');
    $table->timestamps();
    
    $table->index(['source_type', 'processed_at']);
    $table->index(['sourceable_type', 'sourceable_id']);
});
```

---

## üéØ –ú–æ–¥–µ–ª–∏

### –ë–∞–∑–æ–≤–∞—è –º–æ–¥–µ–ª—å —Å –æ–±—â–∏–º–∏ –º–µ—Ç–æ–¥–∞–º–∏

```php
namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;
use Illuminate\Database\Eloquent\Relations\MorphMany;

abstract class BaseTrendModel extends Model
{
    use SoftDeletes;
    
    protected $dates = ['deleted_at', 'parsed_at', 'last_synced_at'];
    
    // –ö–∞—Å—Ç—ã
    protected $casts = [
        'metadata' => 'array',
        'is_active' => 'boolean',
        'is_exclusive' => 'boolean',
        'parsed_at' => 'datetime',
        'last_synced_at' => 'datetime',
    ];
    
    // –°–≤—è–∑—å —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ (–ø–æ–ª–∏–º–æ—Ä—Ñ–Ω–∞—è)
    public function images()
    {
        return $this->morphMany(Image::class, 'imageable')->orderBy('sort_order');
    }
    
    // –ì–ª–∞–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    public function mainImage()
    {
        return $this->morphOne(Image::class, 'imageable')
            ->where('is_main', true)
            ->orderBy('sort_order');
    }
    
    // –°–≤—è–∑—å —Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö
    public function dataSources()
    {
        return $this->morphMany(DataSource::class, 'sourceable')->latest();
    }
    
    // Scope –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö
    public function scopeActive($query)
    {
        return $query->where('is_active', true);
    }
    
    // Scope –¥–ª—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    public function scopeFromSource($query, string $source)
    {
        return $query->where('data_source', $source);
    }
    
    // Scope –¥–ª—è –ø–∞—Ä—Å–µ—Ä–∞
    public function scopeFromParser($query)
    {
        return $query->where('data_source', 'parser');
    }
}
```

### –ü—Ä–∏–º–µ—Ä –º–æ–¥–µ–ª–∏ Block

```php
namespace App\Models;

use App\Models\Traits\Filterable;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Database\Eloquent\Relations\BelongsToMany;
use Illuminate\Database\Eloquent\Relations\HasMany;

class Block extends BaseTrendModel
{
    use Filterable;
    
    protected $fillable = [
        'city_id', 'region_id', 'location_id', 'builder_id',
        'guid', 'name', 'address', 'crm_id', 'external_id',
        'latitude', 'longitude',
        'status', 'edit_mode', 'is_suite', 'is_exclusive', 'is_marked', 'is_active',
        'min_price', 'max_price',
        'apartments_count', 'view_apartments_count', 'exclusive_apartments_count',
        'deadline', 'deadline_date', 'deadline_over_check', 'finishing',
        'data_source', 'parsed_at', 'last_synced_at',
        'metadata', 'advantages', 'payment_types', 'contract_types', 'installments',
    ];
    
    // –û—Ç–Ω–æ—à–µ–Ω–∏—è
    public function city(): BelongsTo
    {
        return $this->belongsTo(City::class);
    }
    
    public function region(): BelongsTo
    {
        return $this->belongsTo(Region::class);
    }
    
    public function location(): BelongsTo
    {
        return $this->belongsTo(Location::class);
    }
    
    public function builder(): BelongsTo
    {
        return $this->belongsTo(Builder::class);
    }
    
    public function subways(): BelongsToMany
    {
        return $this->belongsToMany(Subway::class, 'block_subways')
            ->withPivot(['distance_time', 'distance_type_id', 'distance_type', 'priority'])
            ->withTimestamps()
            ->orderByPivot('priority');
    }
    
    public function prices(): HasMany
    {
        return $this->hasMany(BlockPrice::class)->orderBy('sort_order');
    }
    
    // Scopes
    public function scopeExclusive($query)
    {
        return $query->where('is_exclusive', true);
    }
    
    public function scopeByCity($query, $cityId)
    {
        return $query->where('city_id', $cityId);
    }
    
    public function scopeByBuilder($query, $builderId)
    {
        return $query->where('builder_id', $builderId);
    }
    
    // Accessors
    public function getFormattedMinPriceAttribute(): ?string
    {
        return $this->min_price ? number_format($this->min_price / 100, 0, '.', ' ') . ' ‚ÇΩ' : null;
    }
    
    public function getFormattedMaxPriceAttribute(): ?string
    {
        return $this->max_price ? number_format($this->max_price / 100, 0, '.', ' ') . ' ‚ÇΩ' : null;
    }
}
```

---

## üîç –§–∏–ª—å—Ç—Ä—ã

### BlockFilter

```php
namespace App\Http\Filters;

use App\Http\Filters\AbstractFilter;
use Illuminate\Database\Eloquent\Builder;

class BlockFilter extends AbstractFilter
{
    protected function getCallbacks(): array
    {
        return [
            'city_id' => [$this, 'cityId'],
            'region_id' => [$this, 'regionId'],
            'location_id' => [$this, 'locationId'],
            'builder_id' => [$this, 'builderId'],
            'is_exclusive' => [$this, 'exclusive'],
            'is_active' => [$this, 'active'],
            'min_price' => [$this, 'minPrice'],
            'max_price' => [$this, 'maxPrice'],
            'deadline' => [$this, 'deadline'],
            'finishing' => [$this, 'finishing'],
            'data_source' => [$this, 'dataSource'],
            'search' => [$this, 'search'],
            'subway_id' => [$this, 'subway'],
            'sort' => [$this, 'sort'],
        ];
    }
    
    protected function cityId(Builder $builder, $value)
    {
        $builder->where('city_id', $value);
    }
    
    protected function regionId(Builder $builder, $value)
    {
        $builder->where('region_id', $value);
    }
    
    protected function locationId(Builder $builder, $value)
    {
        $builder->where('location_id', $value);
    }
    
    protected function builderId(Builder $builder, $value)
    {
        $builder->where('builder_id', $value);
    }
    
    protected function exclusive(Builder $builder, $value)
    {
        $builder->where('is_exclusive', filter_var($value, FILTER_VALIDATE_BOOLEAN));
    }
    
    protected function active(Builder $builder, $value)
    {
        $builder->where('is_active', filter_var($value, FILTER_VALIDATE_BOOLEAN));
    }
    
    protected function minPrice(Builder $builder, $value)
    {
        $builder->where('min_price', '>=', $value * 100); // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –∫–æ–ø–µ–π–∫–∏
    }
    
    protected function maxPrice(Builder $builder, $value)
    {
        $builder->where('max_price', '<=', $value * 100);
    }
    
    protected function deadline(Builder $builder, $value)
    {
        $builder->where('deadline', 'like', "%{$value}%");
    }
    
    protected function finishing(Builder $builder, $value)
    {
        $builder->where('finishing', $value);
    }
    
    protected function dataSource(Builder $builder, $value)
    {
        $builder->where('data_source', $value);
    }
    
    protected function search(Builder $builder, $value)
    {
        $builder->where(function($query) use ($value) {
            $query->whereFullText(['name', 'address'], $value)
                ->orWhere('name', 'like', "%{$value}%")
                ->orWhere('address', 'like', "%{$value}%");
        });
    }
    
    protected function subway(Builder $builder, $value)
    {
        $builder->whereHas('subways', function($query) use ($value) {
            $query->where('subways.id', $value);
        });
    }
    
    protected function sort(Builder $builder, $value)
    {
        $direction = $this->getQueryParam('sort_direction', 'asc');
        
        match($value) {
            'price' => $builder->orderBy('min_price', $direction),
            'name' => $builder->orderBy('name', $direction),
            'deadline' => $builder->orderBy('deadline_date', $direction),
            'created' => $builder->orderBy('created_at', $direction),
            default => $builder->orderBy('created_at', 'desc'),
        };
    }
    
    protected function before(Builder $builder)
    {
        // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ
        if (!$this->getQueryParam('include_inactive')) {
            $builder->active();
        }
    }
}
```

---

## üì¶ –†–µ—Å—É—Ä—Å—ã

### BlockResource

```php
namespace App\Http\Resources;

use Illuminate\Http\Request;
use Illuminate\Http\Resources\Json\JsonResource;

class BlockResource extends JsonResource
{
    public function toArray(Request $request): array
    {
        return [
            'id' => $this->id,
            'guid' => $this->guid,
            'name' => $this->name,
            'address' => $this->address,
            'external_id' => $this->external_id,
            
            // –°–≤—è–∑–∏
            'city' => new CityResource($this->whenLoaded('city')),
            'region' => new RegionResource($this->whenLoaded('region')),
            'location' => new LocationResource($this->whenLoaded('location')),
            'builder' => new BuilderResource($this->whenLoaded('builder')),
            'subways' => SubwayResource::collection($this->whenLoaded('subways')),
            'prices' => BlockPriceResource::collection($this->whenLoaded('prices')),
            'images' => ImageResource::collection($this->whenLoaded('images')),
            'main_image' => new ImageResource($this->whenLoaded('mainImage')),
            
            // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
            'coordinates' => [
                'latitude' => $this->latitude,
                'longitude' => $this->longitude,
            ],
            
            // –¶–µ–Ω—ã
            'prices' => [
                'min' => $this->min_price,
                'max' => $this->max_price,
                'min_formatted' => $this->formatted_min_price,
                'max_formatted' => $this->formatted_max_price,
            ],
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            'stats' => [
                'apartments_count' => $this->apartments_count,
                'view_apartments_count' => $this->view_apartments_count,
                'exclusive_apartments_count' => $this->exclusive_apartments_count,
            ],
            
            // –°—Ç–∞—Ç—É—Å—ã
            'status' => $this->status,
            'is_suite' => $this->is_suite,
            'is_exclusive' => $this->is_exclusive,
            'is_marked' => $this->is_marked,
            'is_active' => $this->is_active,
            
            // –°—Ä–æ–∫–∏
            'deadline' => $this->deadline,
            'deadline_date' => $this->deadline_date?->toIso8601String(),
            'finishing' => $this->finishing,
            
            // –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö
            'data_source' => $this->data_source,
            'parsed_at' => $this->parsed_at?->toIso8601String(),
            'last_synced_at' => $this->last_synced_at?->toIso8601String(),
            
            // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
            'metadata' => $this->metadata,
            'advantages' => $this->advantages,
            'payment_types' => $this->payment_types,
            'contract_types' => $this->contract_types,
            
            'created_at' => $this->created_at->toIso8601String(),
            'updated_at' => $this->updated_at->toIso8601String(),
        ];
    }
}
```

---

## ‚úÖ –ó–∞–ø—Ä–æ—Å—ã (FormRequest)

### StoreBlockRequest

```php
namespace App\Http\Requests;

use Illuminate\Foundation\Http\FormRequest;

class StoreBlockRequest extends FormRequest
{
    public function authorize(): bool
    {
        return $this->user()->can('create', Block::class);
    }
    
    public function rules(): array
    {
        return [
            'city_id' => ['required', 'exists:cities,id'],
            'region_id' => ['nullable', 'exists:regions,id'],
            'location_id' => ['nullable', 'exists:locations,id'],
            'builder_id' => ['nullable', 'exists:builders,id'],
            
            'guid' => ['required', 'string', 'max:255', 'unique:blocks,guid'],
            'name' => ['required', 'string', 'max:255'],
            'address' => ['nullable', 'string'],
            'crm_id' => ['nullable', 'integer'],
            'external_id' => ['nullable', 'string', 'max:255'],
            
            'latitude' => ['nullable', 'numeric', 'between:-90,90'],
            'longitude' => ['nullable', 'numeric', 'between:-180,180'],
            
            'status' => ['nullable', 'integer'],
            'is_suite' => ['nullable', 'boolean'],
            'is_exclusive' => ['nullable', 'boolean'],
            'is_marked' => ['nullable', 'boolean'],
            'is_active' => ['nullable', 'boolean'],
            
            'min_price' => ['nullable', 'integer', 'min:0'],
            'max_price' => ['nullable', 'integer', 'min:0'],
            
            'deadline' => ['nullable', 'string', 'max:255'],
            'deadline_date' => ['nullable', 'date'],
            'finishing' => ['nullable', 'string', 'max:255'],
            
            'data_source' => ['nullable', 'in:parser,manual,feed,import'],
            
            'metadata' => ['nullable', 'array'],
            'advantages' => ['nullable', 'array'],
            'payment_types' => ['nullable', 'array'],
            'contract_types' => ['nullable', 'array'],
            
            // –°–≤—è–∑–∏
            'subway_ids' => ['nullable', 'array'],
            'subway_ids.*' => ['exists:subways,id'],
        ];
    }
    
    protected function prepareForValidation()
    {
        // –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω –∏—Å—Ç–æ—á–Ω–∏–∫, —Å—Ç–∞–≤–∏–º manual
        if (!$this->has('data_source')) {
            $this->merge(['data_source' => 'manual']);
        }
        
        // –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω is_active, —Å—Ç–∞–≤–∏–º true
        if (!$this->has('is_active')) {
            $this->merge(['is_active' => true]);
        }
    }
}
```

### UpdateBlockRequest

```php
namespace App\Http\Requests;

use Illuminate\Foundation\Http\FormRequest;
use Illuminate\Validation\Rule;

class UpdateBlockRequest extends FormRequest
{
    public function authorize(): bool
    {
        return $this->user()->can('update', $this->route('block'));
    }
    
    public function rules(): array
    {
        $blockId = $this->route('block')->id;
        
        return [
            'city_id' => ['sometimes', 'exists:cities,id'],
            'region_id' => ['nullable', 'exists:regions,id'],
            'location_id' => ['nullable', 'exists:locations,id'],
            'builder_id' => ['nullable', 'exists:builders,id'],
            
            'guid' => ['sometimes', 'string', 'max:255', Rule::unique('blocks', 'guid')->ignore($blockId)],
            'name' => ['sometimes', 'string', 'max:255'],
            'address' => ['nullable', 'string'],
            'crm_id' => ['nullable', 'integer'],
            'external_id' => ['nullable', 'string', 'max:255'],
            
            // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ StoreBlockRequest
        ];
    }
}
```

---

## üîó –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ

```php
namespace App\Http\Controllers\Api;

use App\Http\Filters\BlockFilter;
use App\Http\Requests\StoreBlockRequest;
use App\Http\Requests\UpdateBlockRequest;
use App\Http\Resources\BlockResource;
use App\Models\Block;
use Illuminate\Http\Request;

class BlockController extends Controller
{
    public function index(Request $request)
    {
        $blocks = Block::query()
            ->with(['city', 'region', 'location', 'builder', 'subways', 'mainImage'])
            ->filter(new BlockFilter($request->all()))
            ->paginate($request->get('per_page', 15));
        
        return BlockResource::collection($blocks);
    }
    
    public function store(StoreBlockRequest $request)
    {
        $block = Block::create($request->validated());
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–≤—è–∑–µ–π
        if ($request->has('subway_ids')) {
            $block->subways()->sync($request->subway_ids);
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –æ–± –∏—Å—Ç–æ—á–Ω–∏–∫–µ
        $block->dataSources()->create([
            'source_type' => $request->data_source ?? 'manual',
            'source_name' => 'API',
            'user_id' => $request->user()->id,
            'processed_at' => now(),
        ]);
        
        return new BlockResource($block->load(['city', 'builder', 'mainImage']));
    }
    
    public function show(Block $block)
    {
        $block->load(['city', 'region', 'location', 'builder', 'subways', 'prices', 'images']);
        return new BlockResource($block);
    }
    
    public function update(UpdateBlockRequest $request, Block $block)
    {
        $block->update($request->validated());
        
        if ($request->has('subway_ids')) {
            $block->subways()->sync($request->subway_ids);
        }
        
        return new BlockResource($block->load(['city', 'builder', 'mainImage']));
    }
    
    public function destroy(Block $block)
    {
        $block->delete();
        return response()->json(['message' => 'Block deleted successfully']);
    }
}
```

---

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

1. **–ò–Ω–¥–µ–∫—Å—ã:** –í—Å–µ –≤–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏ –∏ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–æ–ª—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω—ã
2. **Soft Deletes:** –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –º—è–≥–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
3. **–ü–æ–ª–∏–º–æ—Ä—Ñ–Ω—ã–µ —Å–≤—è–∑–∏:** –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ø–æ–ª–∏–º–æ—Ä—Ñ–Ω—É—é —Å–≤—è–∑—å –¥–ª—è –≥–∏–±–∫–æ—Å—Ç–∏
4. **–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö:** –ü–æ–ª–µ `data_source` –∏ —Ç–∞–±–ª–∏—Ü–∞ `data_sources` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏—è
5. **–¶–µ–Ω—ã:** –•—Ä–∞–Ω—è—Ç—Å—è –≤ –∫–æ–ø–µ–π–∫–∞—Ö (integer) –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
6. **–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:** Decimal –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
7. **JSON –ø–æ–ª—è:** –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –≥–∏–±–∫–∏—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä –¥–∞–Ω–Ω—ã—Ö (metadata, advantages –∏ —Ç.–¥.)

---

**–î–æ–∫—É–º–µ–Ω—Ç –±—É–¥–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–µ–Ω —Å –ø–æ–ª–Ω—ã–º–∏ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ –≤ —Å–ª–µ–¥—É—é—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏...**

