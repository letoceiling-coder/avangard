# –ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–∞—Ä—Å–µ—Ä–∞ TrendAgent

–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ –≤—Å–µ–º–∏ –º–æ–¥–µ–ª—è–º–∏, —Ñ–∏–ª—å—Ç—Ä–∞–º–∏, —Ä–µ—Å—É—Ä—Å–∞–º–∏, –∑–∞–ø—Ä–æ—Å–∞–º–∏ –∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-12-28

---

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-—Ç–∞–±–ª–∏—Ü)
2. [–ú–æ–¥–µ–ª–∏ Eloquent](#–º–æ–¥–µ–ª–∏-eloquent)
3. [–§–∏–ª—å—Ç—Ä—ã](#—Ñ–∏–ª—å—Ç—Ä—ã)
4. [–†–µ—Å—É—Ä—Å—ã (API Resources)](#—Ä–µ—Å—É—Ä—Å—ã-api-resources)
5. [Form Requests](#form-requests)
6. [–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã](#–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã)
7. [–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è](#–ø—Ä–∏–º–µ—Ä—ã-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü

### –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏

- `cities` - –ì–æ—Ä–æ–¥–∞
- `regions` - –†–∞–π–æ–Ω—ã
- `locations` - –õ–æ–∫–∞—Ü–∏–∏/–û–∫—Ä—É–≥–∞
- `builders` - –ó–∞—Å—Ç—Ä–æ–π—â–∏–∫–∏
- `subway_lines` - –õ–∏–Ω–∏–∏ –º–µ—Ç—Ä–æ
- `subways` - –°—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –æ–±—ä–µ–∫—Ç–æ–≤

- `blocks` - –ñ–ö / –ë–ª–æ–∫–∏ –∫–≤–∞—Ä—Ç–∏—Ä
- `block_subways` - –°–≤—è–∑—å –±–ª–æ–∫–æ–≤ –∏ —Å—Ç–∞–Ω—Ü–∏–π –º–µ—Ç—Ä–æ (pivot)
- `block_prices` - –¶–µ–Ω—ã –ø–æ —Ç–∏–ø–∞–º –∫–≤–∞—Ä—Ç–∏—Ä

- `parkings` - –ü–∞—Ä–∫–æ–≤–æ—á–Ω—ã–µ –º–µ—Å—Ç–∞
- `parking_subways` - –°–≤—è–∑—å –ø–∞—Ä–∫–∏–Ω–≥–∞ –∏ –º–µ—Ç—Ä–æ (pivot)

- `villages` - –ü–æ—Å–µ–ª–∫–∏ / –î–æ–º–∞ —Å —É—á–∞—Å—Ç–∫–∞–º–∏
- `village_prices` - –¶–µ–Ω—ã –ø–æ—Å–µ–ª–∫–æ–≤ –ø–æ —Ç–∏–ø–∞–º —É—á–∞—Å—Ç–∫–æ–≤

- `commercial_blocks` - –ö–æ–º–º–µ—Ä—á–µ—Å–∫–∏–µ –±–ª–æ–∫–∏
- `commercial_block_subways` - –°–≤—è–∑—å –∫–æ–º–º–µ—Ä—Ü–∏–∏ –∏ –º–µ—Ç—Ä–æ (pivot)

### –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã

- `images` - –ü–æ–ª–∏–º–æ—Ä—Ñ–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- `data_sources` - –õ–æ–≥–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö

---

## üéØ –ú–æ–¥–µ–ª–∏ Eloquent

### –ë–∞–∑–æ–≤—ã–µ –º–æ–¥–µ–ª–∏

#### BaseTrendModel

–°–º. `app/Models/Trend/BaseTrendModel.php`

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- Soft Deletes
- –ü–æ–ª–∏–º–æ—Ä—Ñ–Ω—ã–µ —Å–≤—è–∑–∏ —Å Image –∏ DataSource
- Scopes –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫—É –¥–∞–Ω–Ω—ã—Ö

#### Image

–°–º. `app/Models/Image.php`

**–ú–µ—Ç–æ–¥—ã:**
- `full_url` - Accessor –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ URL
- `thumbnail_url` - Accessor –¥–ª—è –º–∏–Ω–∏–∞—Ç—é—Ä—ã
- `imageable()` - –ü–æ–ª–∏–º–æ—Ä—Ñ–Ω–∞—è —Å–≤—è–∑—å

#### DataSource

–°–º. `app/Models/DataSource.php`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π

---

### –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏

#### City

```php
namespace App\Models\Trend;

class City extends Model
{
    use SoftDeletes;
    
    protected $fillable = ['guid', 'name', 'crm_id', 'external_id', 'is_active', 'sort_order'];
    
    protected $casts = ['is_active' => 'boolean'];
    
    public function regions()
    {
        return $this->hasMany(Region::class);
    }
    
    public function locations()
    {
        return $this->hasMany(Location::class);
    }
    
    public function subways()
    {
        return $this->hasMany(Subway::class);
    }
    
    public function blocks()
    {
        return $this->hasMany(Block::class);
    }
}
```

#### Builder

```php
namespace App\Models\Trend;

class Builder extends Model
{
    use SoftDeletes;
    
    protected $fillable = [
        'guid', 'name', 'crm_id', 'external_id',
        'description', 'website', 'email', 'phone',
        'is_active', 'is_exclusive', 'sort_order'
    ];
    
    protected $casts = [
        'is_active' => 'boolean',
        'is_exclusive' => 'boolean',
    ];
    
    public function blocks()
    {
        return $this->hasMany(Block::class);
    }
    
    public function parkings()
    {
        return $this->hasMany(Parking::class);
    }
    
    public function villages()
    {
        return $this->hasMany(Village::class);
    }
    
    public function commercialBlocks()
    {
        return $this->hasMany(CommercialBlock::class);
    }
}
```

#### Subway

```php
namespace App\Models\Trend;

class Subway extends Model
{
    use SoftDeletes;
    
    protected $fillable = [
        'subway_line_id', 'city_id', 'guid', 'name',
        'crm_id', 'external_id',
        'latitude', 'longitude', 'priority',
        'is_active', 'sort_order'
    ];
    
    protected $casts = [
        'latitude' => 'decimal:8',
        'longitude' => 'decimal:8',
        'is_active' => 'boolean',
    ];
    
    public function subwayLine()
    {
        return $this->belongsTo(SubwayLine::class);
    }
    
    public function city()
    {
        return $this->belongsTo(City::class);
    }
    
    public function blocks()
    {
        return $this->belongsToMany(Block::class, 'block_subways')
            ->withPivot(['distance_time', 'distance_type_id', 'distance_type', 'priority'])
            ->withTimestamps();
    }
    
    public function parkings()
    {
        return $this->belongsToMany(Parking::class, 'parking_subways')
            ->withPivot(['distance_time', 'distance_type_id', 'priority'])
            ->withTimestamps();
    }
}
```

---

### –û—Å–Ω–æ–≤–Ω—ã–µ –º–æ–¥–µ–ª–∏ –æ–±—ä–µ–∫—Ç–æ–≤

#### Block (–ñ–ö)

```php
namespace App\Models\Trend;

use App\Models\Traits\Filterable;

class Block extends BaseTrendModel
{
    use Filterable;
    
    protected $fillable = [
        'city_id', 'region_id', 'location_id', 'builder_id',
        'guid', 'name', 'address', 'crm_id', 'external_id',
        'latitude', 'longitude',
        'status', 'edit_mode', 'is_suite', 'is_exclusive', 'is_marked', 'is_active',
        'min_price', 'max_price',
        'apartments_count', 'view_apartments_count', 'exclusive_apartments_count',
        'deadline', 'deadline_date', 'deadline_over_check', 'finishing',
        'data_source', 'parsed_at', 'last_synced_at',
        'metadata', 'advantages', 'payment_types', 'contract_types', 'installments',
    ];
    
    protected $casts = [
        'metadata' => 'array',
        'advantages' => 'array',
        'payment_types' => 'array',
        'contract_types' => 'array',
        'installments' => 'array',
        'is_suite' => 'boolean',
        'is_exclusive' => 'boolean',
        'is_marked' => 'boolean',
        'is_active' => 'boolean',
        'deadline_over_check' => 'boolean',
        'deadline_date' => 'datetime',
        'latitude' => 'decimal:8',
        'longitude' => 'decimal:8',
        'min_price' => 'integer',
        'max_price' => 'integer',
    ];
    
    // –û—Ç–Ω–æ—à–µ–Ω–∏—è
    public function city()
    {
        return $this->belongsTo(City::class);
    }
    
    public function region()
    {
        return $this->belongsTo(Region::class);
    }
    
    public function location()
    {
        return $this->belongsTo(Location::class);
    }
    
    public function builder()
    {
        return $this->belongsTo(Builder::class);
    }
    
    public function subways()
    {
        return $this->belongsToMany(Subway::class, 'block_subways')
            ->withPivot(['distance_time', 'distance_type_id', 'distance_type', 'priority'])
            ->withTimestamps()
            ->orderByPivot('priority');
    }
    
    public function prices()
    {
        return $this->hasMany(BlockPrice::class)->orderBy('sort_order');
    }
    
    // Scopes
    public function scopeExclusive($query)
    {
        return $query->where('is_exclusive', true);
    }
    
    public function scopeByCity($query, $cityId)
    {
        return $query->where('city_id', $cityId);
    }
    
    public function scopeByBuilder($query, $builderId)
    {
        return $query->where('builder_id', $builderId);
    }
    
    // Accessors
    public function getFormattedMinPriceAttribute(): ?string
    {
        return $this->min_price ? number_format($this->min_price / 100, 0, '.', ' ') . ' ‚ÇΩ' : null;
    }
    
    public function getFormattedMaxPriceAttribute(): ?string
    {
        return $this->max_price ? number_format($this->max_price / 100, 0, '.', ' ') . ' ‚ÇΩ' : null;
    }
}
```

#### BlockPrice

```php
namespace App\Models\Trend;

class BlockPrice extends Model
{
    protected $fillable = [
        'block_id', 'room_type_id', 'room_type_name', 'price', 'sort_order'
    ];
    
    protected $casts = [
        'price' => 'integer',
        'room_type_id' => 'integer',
        'sort_order' => 'integer',
    ];
    
    public function block()
    {
        return $this->belongsTo(Block::class);
    }
    
    public function getFormattedPriceAttribute(): ?string
    {
        return $this->price ? number_format($this->price / 100, 0, '.', ' ') . ' ‚ÇΩ' : null;
    }
}
```

#### Parking

```php
namespace App\Models\Trend;

use App\Models\Traits\Filterable;

class Parking extends BaseTrendModel
{
    use Filterable;
    
    protected $fillable = [
        'block_id', 'city_id', 'district_id', 'location_id', 'builder_id',
        'external_id', 'block_guid', 'block_name', 'number', 'floor', 'area',
        'latitude', 'longitude',
        'parking_type', 'place_type', 'property_type', 'status', 'status_label',
        'price', 'reward_label',
        'deadline', 'deadline_date', 'deadline_over_check',
        'data_source', 'parsed_at', 'last_synced_at',
        'metadata',
    ];
    
    protected $casts = [
        'metadata' => 'array',
        'floor' => 'integer',
        'area' => 'decimal:2',
        'latitude' => 'decimal:8',
        'longitude' => 'decimal:8',
        'price' => 'integer',
        'deadline_over_check' => 'boolean',
        'deadline_date' => 'datetime',
    ];
    
    public function block()
    {
        return $this->belongsTo(Block::class);
    }
    
    public function city()
    {
        return $this->belongsTo(City::class);
    }
    
    public function district()
    {
        return $this->belongsTo(Region::class, 'district_id');
    }
    
    public function location()
    {
        return $this->belongsTo(Location::class);
    }
    
    public function builder()
    {
        return $this->belongsTo(Builder::class);
    }
    
    public function subways()
    {
        return $this->belongsToMany(Subway::class, 'parking_subways')
            ->withPivot(['distance_time', 'distance_type_id', 'priority'])
            ->withTimestamps()
            ->orderByPivot('priority');
    }
}
```

#### Village (–ü–æ—Å–µ–ª–æ–∫)

```php
namespace App\Models\Trend;

use App\Models\Traits\Filterable;

class Village extends BaseTrendModel
{
    use Filterable;
    
    protected $fillable = [
        'city_id', 'builder_id',
        'guid', 'name', 'address', 'external_id',
        'plots_count', 'view_plots_count',
        'distance',
        'deadline', 'deadline_date', 'sales_start', 'sales_start_date',
        'reward_label',
        'is_new_village', 'is_active',
        'data_source', 'parsed_at', 'last_synced_at',
        'metadata', 'property_types',
    ];
    
    protected $casts = [
        'distance' => 'array',
        'metadata' => 'array',
        'property_types' => 'array',
        'is_new_village' => 'boolean',
        'is_active' => 'boolean',
        'deadline_date' => 'datetime',
        'sales_start_date' => 'datetime',
    ];
    
    public function city()
    {
        return $this->belongsTo(City::class);
    }
    
    public function builder()
    {
        return $this->belongsTo(Builder::class);
    }
    
    public function prices()
    {
        return $this->hasMany(VillagePrice::class)->orderBy('sort_order');
    }
}
```

#### CommercialBlock

```php
namespace App\Models\Trend;

use App\Models\Traits\Filterable;

class CommercialBlock extends BaseTrendModel
{
    use Filterable;
    
    protected $fillable = [
        'city_id', 'builder_id', 'district_id', 'location_id',
        'guid', 'name', 'address', 'external_id',
        'premises_count', 'booked_premises_count',
        'is_new_block', 'is_active',
        'deadlines', 'deadline_date', 'deadline_over_check', 'sales_start_at',
        'reward_label',
        'data_source', 'parsed_at', 'last_synced_at',
        'metadata', 'property_types', 'min_prices',
    ];
    
    protected $casts = [
        'deadlines' => 'array',
        'sales_start_at' => 'array',
        'metadata' => 'array',
        'property_types' => 'array',
        'min_prices' => 'array',
        'is_new_block' => 'boolean',
        'is_active' => 'boolean',
        'deadline_over_check' => 'boolean',
        'deadline_date' => 'datetime',
    ];
    
    public function city()
    {
        return $this->belongsTo(City::class);
    }
    
    public function builder()
    {
        return $this->belongsTo(Builder::class);
    }
    
    public function district()
    {
        return $this->belongsTo(Region::class, 'district_id');
    }
    
    public function location()
    {
        return $this->belongsTo(Location::class);
    }
    
    public function subways()
    {
        return $this->belongsToMany(Subway::class, 'commercial_block_subways')
            ->withPivot(['distance_time', 'distance_type_id', 'priority'])
            ->withTimestamps()
            ->orderByPivot('priority');
    }
}
```

---

## üîç –§–∏–ª—å—Ç—Ä—ã

–í—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã –Ω–∞—Å–ª–µ–¥—É—é—Ç—Å—è –æ—Ç `AbstractFilter` –∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç trait `Filterable` –≤ –º–æ–¥–µ–ª—è—Ö.

### BlockFilter

–°–º. –ø–æ–ª–Ω—ã–π –∫–æ–¥ –≤ `TREND_DATABASE_DESIGN.md`

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã:**
- `city_id`, `region_id`, `location_id`, `builder_id`
- `is_exclusive`, `is_active`
- `min_price`, `max_price`
- `deadline`, `finishing`
- `data_source`
- `search` (–ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫)
- `subway_id`
- `sort` + `sort_direction`

### ParkingFilter

–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ BlockFilter, –Ω–æ —Å–æ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–º–∏ –ø–æ–ª—è–º–∏ –ø–∞—Ä–∫–∏–Ω–≥–∞.

### VillageFilter

–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ, –Ω–æ –¥–ª—è –ø–æ—Å–µ–ª–∫–æ–≤.

### CommercialBlockFilter

–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ, –Ω–æ –¥–ª—è –∫–æ–º–º–µ—Ä—Ü–∏–∏.

---

## üì¶ –†–µ—Å—É—Ä—Å—ã (API Resources)

### BlockResource

–°–º. –ø–æ–ª–Ω—ã–π –∫–æ–¥ –≤ `TREND_DATABASE_DESIGN.md`

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –£—Å–ª–æ–≤–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å–≤—è–∑–µ–π —á–µ—Ä–µ–∑ `whenLoaded()`
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ü–µ–Ω—ã
- –í–ª–æ–∂–µ–Ω–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã –¥–ª—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π

### ImageResource

```php
namespace App\Http\Resources;

use Illuminate\Http\Request;
use Illuminate\Http\Resources\Json\JsonResource;

class ImageResource extends JsonResource
{
    public function toArray(Request $request): array
    {
        return [
            'id' => $this->id,
            'external_id' => $this->external_id,
            'file_name' => $this->file_name,
            'path' => $this->path,
            'url_thumbnail' => $this->thumbnail_url,
            'url_full' => $this->full_url,
            'alt' => $this->alt,
            'title' => $this->title,
            'description' => $this->description,
            'width' => $this->width,
            'height' => $this->height,
            'size' => $this->size,
            'is_main' => $this->is_main,
            'sort_order' => $this->sort_order,
        ];
    }
}
```

---

## ‚úÖ Form Requests

### StoreBlockRequest / UpdateBlockRequest

–°–º. –ø–æ–ª–Ω—ã–π –∫–æ–¥ –≤ `TREND_DATABASE_DESIGN.md`

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –ø–æ–ª–µ–π
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ `data_source` –∏ `is_active` –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω—ã
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–≤—è–∑–µ–π (city_id, builder_id –∏ —Ç.–¥.)

---

## üéÆ –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã

### BlockController

–°–º. –ø—Ä–∏–º–µ—Ä –≤ `TREND_DATABASE_DESIGN.md`

**–ú–µ—Ç–æ–¥—ã:**
- `index()` - –°–ø–∏—Å–æ–∫ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
- `store()` - –°–æ–∑–¥–∞–Ω–∏–µ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∞
- `show()` - –ü—Ä–æ—Å–º–æ—Ç—Ä –æ–¥–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
- `update()` - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
- `destroy()` - –ú—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ

---

## üìñ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°–æ–∑–¥–∞–Ω–∏–µ –±–ª–æ–∫–∞ –∏–∑ –ø–∞—Ä—Å–µ—Ä–∞

```php
use App\Models\Trend\Block;
use App\Models\Trend\City;
use App\Models\Trend\Builder;

// –ù–∞–π—Ç–∏ –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –≥–æ—Ä–æ–¥
$city = City::firstOrCreate(
    ['guid' => 'msk'],
    ['name' => '–ú–æ—Å–∫–≤–∞', 'is_active' => true]
);

// –ù–∞–π—Ç–∏ –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–∞
$builder = Builder::firstOrCreate(
    ['guid' => 'Capitalgroup'],
    ['name' => 'Capital Group', 'is_active' => true]
);

// –°–æ–∑–¥–∞—Ç—å –±–ª–æ–∫
$block = Block::create([
    'city_id' => $city->id,
    'builder_id' => $builder->id,
    'guid' => 'oko',
    'name' => '–ú–§–ö –û–ö–û',
    'address' => '1-–π –ö—Ä–∞—Å–Ω–æ–≥–≤–∞—Ä–¥–µ–π—Å–∫–∏–π –ø—Ä–æ–µ–∑–¥',
    'external_id' => '5ab8d3187be62f4b7f09eb9e',
    'latitude' => 55.749885579644584,
    'longitude' => 37.5343220970532,
    'min_price' => 5000000, // –í –∫–æ–ø–µ–π–∫–∞—Ö
    'data_source' => 'parser',
    'is_active' => true,
]);

// –ü–æ–º–µ—Ç–∏—Ç—å –∫–∞–∫ —Å–ø–∞—Ä—Å–µ–Ω–Ω–æ–µ
$block->markAsParsed();

// –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫
$block->dataSources()->create([
    'source_type' => 'parser',
    'source_name' => 'TrendAgent API',
    'processed_at' => now(),
]);
```

### –ó–∞–ø—Ä–æ—Å —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏

```php
use App\Http\Filters\BlockFilter;
use App\Models\Trend\Block;

$blocks = Block::query()
    ->with(['city', 'builder', 'mainImage'])
    ->filter(new BlockFilter([
        'city_id' => 1,
        'is_exclusive' => true,
        'min_price' => 5000000,
        'max_price' => 15000000,
        'search' => '–û–ö–û',
        'sort' => 'price',
        'sort_direction' => 'asc',
    ]))
    ->paginate(20);
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –±–ª–æ–∫–∞

```php
$block = Block::where('external_id', '5ab8d3187be62f4b7f09eb9e')->first();

if ($block) {
    // –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
    $block->update([
        'apartments_count' => 60,
        'min_price' => 6000000,
        'last_synced_at' => now(),
    ]);
    
    $block->markAsSynced();
} else {
    // –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π
    $block = Block::create([...]);
}
```

### –†–∞–±–æ—Ç–∞ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏

```php
// –°–æ–∑–¥–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –±–ª–æ–∫–∞
$block->images()->create([
    'external_id' => '63c00c0b9a85d5af16f5804c',
    'path' => 'w0/wu/',
    'file_name' => '250ea8a64f4cadf7c24dd727674c0e4a.png',
    'is_main' => true,
    'sort_order' => 0,
]);

// –ü–æ–ª—É—á–∏—Ç—å –≥–ª–∞–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
$mainImage = $block->mainImage;
echo $mainImage->thumbnail_url; // URL –º–∏–Ω–∏–∞—Ç—é—Ä—ã
echo $mainImage->full_url; // URL –ø–æ–ª–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
```

### –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–µ—Ç—Ä–æ

```php
// –ù–∞–π—Ç–∏ —Å—Ç–∞–Ω—Ü–∏–∏ –º–µ—Ç—Ä–æ
$subway1 = Subway::where('guid', 'mezhdunarodnaya')->first();
$subway2 = Subway::where('guid', 'delovoy-centr')->first();

// –ü—Ä–∏–≤—è–∑–∞—Ç—å –∫ –±–ª–æ–∫—É
$block->subways()->sync([
    $subway1->id => [
        'distance_time' => 5,
        'distance_type_id' => 1,
        'distance_type' => '–ø–µ—à–∫–æ–º',
        'priority' => 500,
    ],
    $subway2->id => [
        'distance_time' => 10,
        'distance_type_id' => 1,
        'distance_type' => '–ø–µ—à–∫–æ–º',
        'priority' => 400,
    ],
]);
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è API

```php
use App\Http\Resources\BlockResource;

$block = Block::with([
    'city',
    'region',
    'location',
    'builder',
    'subways',
    'prices',
    'images',
    'mainImage'
])->find(1);

return new BlockResource($block);
```

---

## üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ø–∞—Ä—Å–µ—Ä–∞

### –°—Ç—Ä–∞—Ç–µ–≥–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

1. **–ü–æ–∏—Å–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∑–∞–ø–∏—Å–∏:**
   - –ü–æ `external_id` (–µ—Å–ª–∏ –µ—Å—Ç—å)
   - –ü–æ `guid` + `city_id` (–µ—Å–ª–∏ –Ω–µ—Ç external_id)

2. **–ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ:**
   - –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—è
   - –û–±–Ω–æ–≤–∏—Ç—å `last_synced_at`
   - –°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å –≤ `data_sources`

3. **–ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ:**
   - –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
   - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `data_source = 'parser'`
   - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `parsed_at = now()`

4. **–î–ª—è —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –∏–∑ API:**
   - –í–∞—Ä–∏–∞–Ω—Ç 1: Soft delete —á–µ—Ä–µ–∑ `deleted_at`
   - –í–∞—Ä–∏–∞–Ω—Ç 2: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `is_active = false`

---

**–î–æ–∫—É–º–µ–Ω—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ë–î –¥–ª—è –ø–∞—Ä—Å–µ—Ä–∞ TrendAgent**

