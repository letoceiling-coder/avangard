# Анализ Directories Endpoint от TrendAgent API

## Назначение

Endpoint `https://apartment-api.trendagent.ru/v1/directories` предоставляет справочные данные для фильтрации и отображения информации о недвижимости.

## Критически важные данные для нашего проекта

### 1. Regions (Регионы)

**Что это:** Районы города (например, "Адмиралтейский р-н", "Василеостровский р-н")

**Структура:**
```json
{
  "_id": "5983801cd07ed144bb7cca1b",  // ObjectId
  "guid": "admiralteyskiy",           // Slug
  "crm_id": 24,                       // ID в CRM
  "priority": 500,                    // Приоритет
  "name": "Адмиралтейский р-н"        // Название
}
```

**Использование:** Синхронизация с таблицей `regions` в нашей БД

### 2. Locations (Локации)

**Что это:** Конкретные места, районы, поселки, деревни (например, "г. Всеволожск", "п. Шушары")

**Структура:**
```json
{
  "_id": "5983801ed07ed144bb7cccd3",  // ObjectId
  "guid": "vsevolozhsk",              // Slug
  "name": "г. Всеволожск"              // Название
}
```

**Использование:** Синхронизация с таблицей `locations` в нашей БД

### 3. Subways (Метро)

**Что это:** Станции метро с указанием линии и цвета

**Структура:**
```json
{
  "_id": "58c665598b6aa52311afa1e5",  // ObjectId
  "guid": "avtovo",                   // Slug
  "name": "Автово",                   // Название
  "line_number": 1,                   // Номер линии
  "color": "#bb2f30"                  // Цвет линии
}
```

**Использование:** Синхронизация с таблицей `subways` в нашей БД

### 4. Banks (Банки)

**Что это:** Список банков, предоставляющих ипотеку

**Структура:**
```json
{
  "_id": "58c665588b6aa52311afa040",  // ObjectId
  "guid": "ak-bars",                  // Slug
  "name": "АК Барс банк (ПАО)"        // Название
}
```

**Использование:** Для отображения банков в фильтрах и детальной информации

### 5. Building Types (Типы зданий)

**Что это:** Типы конструкций зданий (монолитный, панельный, кирпичный и т.д.)

**Структура:**
```json
{
  "_id": "58c665588b6aa52311afa017",  // ObjectId
  "crm_id": 0,                        // ID в CRM
  "name": "Монолитный",               // Название
  "name_short": "м"                   // Короткое название
}
```

**Использование:** Для фильтрации и отображения типа здания

## Другие полезные справочники

- **Rooms** - Типы квартир (студии, 1-к, 2-к, 3-к и т.д.)
- **Finishings** - Типы отделки (без отделки, чистовая, подчистовая и т.д.)
- **Contracts** - Типы договоров (ДДУ, ЖСК, КП и т.д.)
- **Payment Types** - Типы оплаты (Ипотека, Рассрочка, Субсидии)
- **Level Types** - Уровни жилья (Стандарт, Комфорт, Бизнес, Элитный)

## Как использовать

### Пример запроса для получения всех справочников

```php
$endpoint = 'https://apartment-api.trendagent.ru/v1/directories';
$params = [
    'auth_token' => $authToken,
    'city' => $city->external_id, // ObjectId города!
    'lang' => 'ru',
    'types' => [
        'regions',
        'locations',
        'subways',
        'banks',
        'building_types',
        'rooms',
        'finishings',
        // ... другие типы
    ]
];

$response = $httpClient->get($endpoint, [
    'query' => array_merge(
        ['auth_token' => $params['auth_token'], 'city' => $params['city'], 'lang' => $params['lang']],
        array_fill_keys($params['types'], null) // Для множественных types
    )
]);
```

### Важно: Множественные параметры types

В URL нужно передать `types` несколько раз:
```
?types=regions&types=locations&types=subways&...
```

В Guzzle это можно сделать через `query` с массивом:
```php
'query' => [
    'types' => ['regions', 'locations', 'subways'], // Guzzle автоматически создаст ?types=regions&types=locations&types=subways
    'city' => $cityId,
    'lang' => 'ru',
    'auth_token' => $token,
]
```

## Преимущества использования этого endpoint

1. **Единый источник данных** - все справочники в одном месте
2. **Актуальность** - данные всегда актуальны для конкретного города
3. **Полнота** - содержит все необходимые справочники
4. **Структурированность** - данные структурированы и готовы к использованию

## План реализации

1. ✅ Создать документацию (этот файл)
2. ⏳ Создать сервис `TrendDirectoriesService` для работы с endpoint
3. ⏳ Создать команду `trend:sync-directories` для синхронизации справочников
4. ⏳ Добавить кэширование справочников
5. ⏳ Интегрировать в парсер для обогащения данных

